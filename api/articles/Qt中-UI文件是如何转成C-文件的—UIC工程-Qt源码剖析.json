{"title":"Qt中 UI文件是如何转成C++文件的—UIC工程(Qt源码剖析)","slug":"Qt中-UI文件是如何转成C-文件的—UIC工程-Qt源码剖析","date":"2020-06-29T13:50:02.000Z","updated":"2020-06-29T13:52:22.047Z","comments":true,"path":"api/articles/Qt中-UI文件是如何转成C-文件的—UIC工程-Qt源码剖析.json","excerpt":null,"covers":["/2020/06/29/qt-zhong-ui-wen-jian-shi-ru-he-zhuan-cheng-c-wen-jian-de-uic-gong-cheng-qt-yuan-ma-pou-xi/uic.png"],"content":"<h1 id=\"序\"><a href=\"#序\" class=\"headerlink\" title=\"序\"></a>序</h1><p>UI文件为标准的XML<br>h文件为标准的Qt语法的文件。<br>先思考一分钟：如何让你来设计，你如何做转化？</p>\n<h1 id=\"过程\"><a href=\"#过程\" class=\"headerlink\" title=\"过程\"></a>过程</h1><p>其实过程很简单<br>读取ui文件（即xml） -&gt; 经过一些规则的变化-&gt; 输出.h文件</p>\n<p>实际上<br>只是单纯的规则变化 - 字符串变化，这个姑且认为是词法分析的一个简单版本吧。（应该算应该算</p>\n<h1 id=\"Qt代码以及位置\"><a href=\"#Qt代码以及位置\" class=\"headerlink\" title=\"Qt代码以及位置\"></a>Qt代码以及位置</h1><p>Qt对应的工程名字为UIC</p>\n<p>代码位置</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">C<span class=\"token operator\">:</span>\\Qt\\Qt5<span class=\"token number\">.14</span><span class=\"token punctuation\">.</span><span class=\"token number\">1</span>\\<span class=\"token number\">5.14</span><span class=\"token punctuation\">.</span><span class=\"token number\">1</span>\\Src\\qtbase\\src\\tools\\uic</code></pre>\n<p>是一个简单的pro文件，可以直接用QtCreator打开</p>\n<h1 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h1><blockquote>\n<p>如果平时有注意Qt的文件编译的时候会发现uic的编译过程的。建议有时间多观察下Qt代码的编译过程，对比C++的编译过程</p>\n</blockquote>\n<h2 id=\"举个栗子\"><a href=\"#举个栗子\" class=\"headerlink\" title=\"举个栗子\"></a>举个栗子</h2><p>我们把 form.ui 转化成 ui_form.h<br>需要在工程配置中<br>在Command line arguments里把对应的命令加上<br>可以看下我的配置<br><img src=\"/2020/06/29/qt-zhong-ui-wen-jian-shi-ru-he-zhuan-cheng-c-wen-jian-de-uic-gong-cheng-qt-yuan-ma-pou-xi/uic.png\" alt></p>\n<p>格式就是<br>源文件(.ui) -o 目标文件(.h)</p>\n<p>然后可以直接点击调试来调试Qt的uic的源码了。</p>\n<h2 id=\"forn-ui\"><a href=\"#forn-ui\" class=\"headerlink\" title=\"forn.ui\"></a>forn.ui</h2><p>这里先贴上form.ui的描述</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ui</span> <span class=\"token attr-name\">version</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>4.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>class</span><span class=\"token punctuation\">></span></span>wpsObject<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>class</span><span class=\"token punctuation\">></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>widget</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>QWidget<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>wpsObject<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>windowModality<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>enum</span><span class=\"token punctuation\">></span></span>Qt::ApplicationModal<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>enum</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>geometry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rect</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>x</span><span class=\"token punctuation\">></span></span>0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>x</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>y</span><span class=\"token punctuation\">></span></span>0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>y</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>width</span><span class=\"token punctuation\">></span></span>481<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>width</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>height</span><span class=\"token punctuation\">></span></span>394<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>height</span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rect</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>windowTitle<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span><span class=\"token punctuation\">></span></span>wpsTitle<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>string</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>widget</span><span class=\"token punctuation\">></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>resources</span><span class=\"token punctuation\">/></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>connections</span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ui</span><span class=\"token punctuation\">></span></span>\n</code></pre>\n<h2 id=\"解析过程\"><a href=\"#解析过程\" class=\"headerlink\" title=\"解析过程\"></a>解析过程</h2><p>比如如何解析UI文件中的widget的一部分信息的代码</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>widget</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>QWidget<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>wpsObject<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>windowModality<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>enum</span><span class=\"token punctuation\">></span></span>Qt::ApplicationModal<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>enum</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>代码在</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">C:\\Qt\\Qt5.14.1\\5.14.1\\Src\\qtbase\\src\\tools\\uic\\ui4.cpp</code></pre>\n<p>中的</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">hasError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> QXmlStreamReader<span class=\"token operator\">::</span>StartElement <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> QStringRef tag <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"author\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setElementAuthor</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readElementText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setElementComment</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readElementText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exportmacro\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setElementExportMacro</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readElementText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setElementClass</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readElementText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"widget\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DomWidget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                v<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">setElementWidget</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span></code></pre>\n<p>重点是解析widget这句</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"widget\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DomWidget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setElementWidget</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>看里面<code>DomWidget</code>的实现</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">hasError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> QXmlStreamReader<span class=\"token operator\">::</span>StartElement <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> QStringRef tag <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                m_class<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">readElementText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"property\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DomProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                v<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                m_property<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">qWarning</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Omitting deprecated element &lt;script>.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                reader<span class=\"token punctuation\">.</span><span class=\"token function\">skipCurrentElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"widgetdata\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">qWarning</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Omitting deprecated element &lt;widgetdata>.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                reader<span class=\"token punctuation\">.</span><span class=\"token function\">skipCurrentElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"attribute\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DomProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                v<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                m_attribute<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span></code></pre>\n<p>重点是这一句</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token function\">QLatin1String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"attribute\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Qt<span class=\"token operator\">::</span>CaseInsensitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DomProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    m_attribute<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>回头再看看我们要解析的ui文件的那部分</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>widget</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>QWidget<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>wpsObject<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>windowModality<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>enum</span><span class=\"token punctuation\">></span></span>Qt::ApplicationModal<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>enum</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>widget中的property元素就是在这里解析的。 </p>\n<p>是不是超级简单？？？！！！！</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>这部分代码个人觉得连编译过程中的语法解析都算不上。只是按照规则，将XML转化成了CPP语法的文件。好吧，听起来也算是语法解析。不过这次算是我们肉眼能够看到的。</p>\n","more":"<h1 id=\"序\"><a href=\"#序\" class=\"headerlink\" title=\"序\"></a>序</h1><p>UI文件为标准的XML<br>h文件为标准的Qt语法的文件。<br>先思考一分钟：如何让你来设计，你如何做转化？</p>\n<h1 id=\"过程\"><a href=\"#过程\" class=\"headerlink\" title=\"过程\"></a>过程</h1><p>其实过程很简单<br>读取ui文件（即xml） -&gt; 经过一些规则的变化-&gt; 输出.h文件</p>\n<p>实际上<br>只是单纯的规则变化 - 字符串变化，这个姑且认为是词法分析的一个简单版本吧。（应该算应该算</p>\n<h1 id=\"Qt代码以及位置\"><a href=\"#Qt代码以及位置\" class=\"headerlink\" title=\"Qt代码以及位置\"></a>Qt代码以及位置</h1><p>Qt对应的工程名字为UIC</p>\n<p>代码位置</p>\n<pre><code class=\"cpp\">C:\\Qt\\Qt5.14.1\\5.14.1\\Src\\qtbase\\src\\tools\\uic</code></pre>\n<p>是一个简单的pro文件，可以直接用QtCreator打开</p>\n<h1 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h1><blockquote>\n<p>如果平时有注意Qt的文件编译的时候会发现uic的编译过程的。建议有时间多观察下Qt代码的编译过程，对比C++的编译过程</p>\n</blockquote>\n<h2 id=\"举个栗子\"><a href=\"#举个栗子\" class=\"headerlink\" title=\"举个栗子\"></a>举个栗子</h2><p>我们把 form.ui 转化成 ui_form.h<br>需要在工程配置中<br>在Command line arguments里把对应的命令加上<br>可以看下我的配置<br><img src=\"/2020/06/29/qt-zhong-ui-wen-jian-shi-ru-he-zhuan-cheng-c-wen-jian-de-uic-gong-cheng-qt-yuan-ma-pou-xi/uic.png\" alt></p>\n<p>格式就是<br>源文件(.ui) -o 目标文件(.h)</p>\n<p>然后可以直接点击调试来调试Qt的uic的源码了。</p>\n<h2 id=\"forn-ui\"><a href=\"#forn-ui\" class=\"headerlink\" title=\"forn.ui\"></a>forn.ui</h2><p>这里先贴上form.ui的描述</p>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;ui version=&quot;4.0&quot;&gt;\n &lt;class&gt;wpsObject&lt;/class&gt;\n &lt;widget class=&quot;QWidget&quot; name=&quot;wpsObject&quot;&gt;\n  &lt;property name=&quot;windowModality&quot;&gt;\n   &lt;enum&gt;Qt::ApplicationModal&lt;/enum&gt;\n  &lt;/property&gt;\n  &lt;property name=&quot;geometry&quot;&gt;\n   &lt;rect&gt;\n    &lt;x&gt;0&lt;/x&gt;\n    &lt;y&gt;0&lt;/y&gt;\n    &lt;width&gt;481&lt;/width&gt;\n    &lt;height&gt;394&lt;/height&gt;\n   &lt;/rect&gt;\n  &lt;/property&gt;\n  &lt;property name=&quot;windowTitle&quot;&gt;\n   &lt;string&gt;wpsTitle&lt;/string&gt;\n  &lt;/property&gt;\n &lt;/widget&gt;\n &lt;resources/&gt;\n &lt;connections/&gt;\n&lt;/ui&gt;\n</code></pre>\n<h2 id=\"解析过程\"><a href=\"#解析过程\" class=\"headerlink\" title=\"解析过程\"></a>解析过程</h2><p>比如如何解析UI文件中的widget的一部分信息的代码</p>\n<pre><code class=\"xml\"> &lt;widget class=&quot;QWidget&quot; name=&quot;wpsObject&quot;&gt;\n  &lt;property name=&quot;windowModality&quot;&gt;\n   &lt;enum&gt;Qt::ApplicationModal&lt;/enum&gt;\n  &lt;/property&gt;</code></pre>\n<p>代码在</p>\n<pre><code class=\"shell\">C:\\Qt\\Qt5.14.1\\5.14.1\\Src\\qtbase\\src\\tools\\uic\\ui4.cpp</code></pre>\n<p>中的</p>\n<pre><code class=\"cpp\">    while (!reader.hasError()) {\n        switch (reader.readNext()) {\n        case QXmlStreamReader::StartElement : {\n            const QStringRef tag = reader.name();\n            if (!tag.compare(QLatin1String(&quot;author&quot;), Qt::CaseInsensitive)) {\n                setElementAuthor(reader.readElementText());\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;comment&quot;), Qt::CaseInsensitive)) {\n                setElementComment(reader.readElementText());\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;exportmacro&quot;), Qt::CaseInsensitive)) {\n                setElementExportMacro(reader.readElementText());\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;class&quot;), Qt::CaseInsensitive)) {\n                setElementClass(reader.readElementText());\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;widget&quot;), Qt::CaseInsensitive)) {\n                auto *v = new DomWidget();\n                v-&gt;read(reader);\n                setElementWidget(v);\n                continue;\n            }</code></pre>\n<p>重点是解析widget这句</p>\n<pre><code class=\"cpp\">if (!tag.compare(QLatin1String(&quot;widget&quot;), Qt::CaseInsensitive)) {\n    auto *v = new DomWidget();\n    v-&gt;read(reader);\n    setElementWidget(v);\n    continue;\n}</code></pre>\n<p>看里面<code>DomWidget</code>的实现</p>\n<pre><code class=\"cpp\">    while (!reader.hasError()) {\n        switch (reader.readNext()) {\n        case QXmlStreamReader::StartElement : {\n            const QStringRef tag = reader.name();\n            if (!tag.compare(QLatin1String(&quot;class&quot;), Qt::CaseInsensitive)) {\n                m_class.append(reader.readElementText());\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;property&quot;), Qt::CaseInsensitive)) {\n                auto *v = new DomProperty();\n                v-&gt;read(reader);\n                m_property.append(v);\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;script&quot;), Qt::CaseInsensitive)) {\n                qWarning(&quot;Omitting deprecated element &lt;script&gt;.&quot;);\n                reader.skipCurrentElement();\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;widgetdata&quot;), Qt::CaseInsensitive)) {\n                qWarning(&quot;Omitting deprecated element &lt;widgetdata&gt;.&quot;);\n                reader.skipCurrentElement();\n                continue;\n            }\n            if (!tag.compare(QLatin1String(&quot;attribute&quot;), Qt::CaseInsensitive)) {\n                auto *v = new DomProperty();\n                v-&gt;read(reader);\n                m_attribute.append(v);\n                continue;\n            }</code></pre>\n<p>重点是这一句</p>\n<pre><code class=\"cpp\">if (!tag.compare(QLatin1String(&quot;attribute&quot;), Qt::CaseInsensitive)) {\n    auto *v = new DomProperty();\n    v-&gt;read(reader);\n    m_attribute.append(v);\n    continue;\n}</code></pre>\n<p>回头再看看我们要解析的ui文件的那部分</p>\n<pre><code class=\"xml\"> &lt;widget class=&quot;QWidget&quot; name=&quot;wpsObject&quot;&gt;\n  &lt;property name=&quot;windowModality&quot;&gt;\n   &lt;enum&gt;Qt::ApplicationModal&lt;/enum&gt;\n  &lt;/property&gt;</code></pre>\n<p>widget中的property元素就是在这里解析的。 </p>\n<p>是不是超级简单？？？！！！！</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>这部分代码个人觉得连编译过程中的语法解析都算不上。只是按照规则，将XML转化成了CPP语法的文件。好吧，听起来也算是语法解析。不过这次算是我们肉眼能够看到的。</p>\n","categories":[{"name":"Qt","path":"api/categories/Qt.json"},{"name":"Qt源码剖析","path":"api/categories/Qt源码剖析.json"}],"tags":[{"name":"Qt","path":"api/tags/Qt.json"},{"name":"Qt源码","path":"api/tags/Qt源码.json"},{"name":"Qt源码剖析","path":"api/tags/Qt源码剖析.json"}]}