{"title":"Qt主界面卡死的解决方案-一些具体实现方式","slug":"Qt主界面卡死的解决方案-一些具体实现方式","date":"2020-05-28T14:18:40.000Z","updated":"2020-05-28T14:20:21.077Z","comments":true,"path":"api/articles/Qt主界面卡死的解决方案-一些具体实现方式.json","excerpt":null,"covers":null,"content":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>我们在写UI文件的时候，有很多情况下，是需要界面来处理业务中某些耗时的操作，这时候如果不处理好界面相关的逻辑的话，主界面就会卡死，这时候就需要我们上多线程了</p>\n<h2 id=\"逻辑1\"><a href=\"#逻辑1\" class=\"headerlink\" title=\"逻辑1\"></a>逻辑1</h2><p>首先上业务上一个很简单的栗子</p>\n<p>比如我们的代码中有这么一个耗时的操作</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token comment\" spellcheck=\"true\">// 第一种耗时的操作</span>\n    <span class=\"token keyword\">auto</span> fWhile1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">qDebug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>i<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>把这个代码绑定到一个按钮事件上</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ui<span class=\"token operator\">-</span><span class=\"token operator\">></span>pushButton1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QPushButton<span class=\"token operator\">::</span>clicked<span class=\"token punctuation\">,</span> fWhile1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>然后点击。发现界面卡死了，很正常，必须得等到这段代码耗时完成之后才能继续操作界面，这段代码是太不友好了，不清真，所以我们要改一下。</p>\n<hr>\n<h2 id=\"逻辑2\"><a href=\"#逻辑2\" class=\"headerlink\" title=\"逻辑2\"></a>逻辑2</h2><p>如何改动，可以看下这个函数</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">QCoreApplication<span class=\"token operator\">::</span>processEvents</code></pre>\n<p>来一起看下官网介绍</p>\n<blockquote>\n<p>Processes all pending events for the calling thread according to the specified flags until there are no more events to process.<br>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).<br>In the event that you are running a local loop which calls this function continuously, without an event loop, the DeferredDelete events will not be processed. This can affect the behaviour of widgets, e.g. QToolTip, that rely on DeferredDelete events to function properly. An alternative would be to call sendPostedEvents() from within that local loop.<br>Calling this function processes events only for the calling thread.<br>Note: This function is thread-safe.</p>\n</blockquote>\n<ul>\n<li>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).</li>\n<li>当程序忙于执行长时间操作（例如复制文件）时，您可以偶尔调用此功能。</li>\n</ul>\n<p>我们就暂时就这个（滑稽。<br>接下来可以把代码搞成这种了。</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token keyword\">auto</span> fWhile2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">qDebug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>i<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span>\n            QApplication<span class=\"token operator\">::</span><span class=\"token function\">processEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ui<span class=\"token operator\">-</span><span class=\"token operator\">></span>pushButton2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QPushButton<span class=\"token operator\">::</span>clicked<span class=\"token punctuation\">,</span> fWhile2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>这种代码在配置不好的机器上实际上还是有点小问题，比如我的小破本子。还是会有点卡的。我觉得用户一般是可以接受这种情况的。</p>\n<hr>\n<h2 id=\"逻辑3\"><a href=\"#逻辑3\" class=\"headerlink\" title=\"逻辑3\"></a>逻辑3</h2><p>实际上这个逻辑还有一个问题，就是如果我的业务代码不是循环该怎么办呢，这时候我们可以用新的类接口</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">QtConcurrent<span class=\"token operator\">::</span>run</code></pre>\n<p>这个类。这个类是可以将一个函数放到新的线程里来执行。再加上</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">QFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></code></pre>\n<p>这个类，可以控制这个新的线程函数开始，控制，结束。<br>具体可以查看官方文档，我这里就上个简单的栗子</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\" spellcheck=\"true\">//耗时的操作</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">function_needmoretime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">qDebug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>i<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">// three</span>\n    <span class=\"token keyword\">auto</span> fWhile3 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token keyword\">void</span>\n    <span class=\"token punctuation\">{</span>\n        QFuture<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token operator\">></span> future <span class=\"token operator\">=</span> QtConcurrent<span class=\"token operator\">::</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>function_needmoretime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>future<span class=\"token punctuation\">.</span><span class=\"token function\">isFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            QApplication<span class=\"token operator\">::</span><span class=\"token function\">processEvents</span><span class=\"token punctuation\">(</span>QEventLoop<span class=\"token operator\">::</span>AllEvents<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ui<span class=\"token operator\">-</span><span class=\"token operator\">></span>pushButton3<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QPushButton<span class=\"token operator\">::</span>clicked<span class=\"token punctuation\">,</span> fWhile3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<p>QFuture + QtConcurrent这个框架非常强大，可以将线程同步异步状态抽象出来，让程序员不用太关心这些。这只是一个最简单的栗子。我的小破本子来运行这个是一点都不卡的。界面依旧如丝滑般流畅。</p>\n<hr>\n<h2 id=\"逻辑4-线程\"><a href=\"#逻辑4-线程\" class=\"headerlink\" title=\"逻辑4-线程\"></a>逻辑4-线程</h2><p>线程基础那种废话我就不多说了。道理大家都懂，我直接上wiki。</p>\n<blockquote>\n<p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在Unix System V及SunOS中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。<br>线程是独立调度和分派的基本单位。线程可以为操作系统内核调度的内核线程，如Win32线程；由用户进程自行调度的用户线程，如Linux平台的POSIX Thread；或者由内核与用户进程，如Windows 7的线程，进行混合调度。<br>同一进程中的多条线程将共享该进程中的全部系统资源，如虚拟地址空间，文件描述符和信号处理等等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。<br>一个进程可以有很多线程，每条线程并行执行不同的任务。<br>在多核或多CPU，或支持Hyper-threading的CPU上使用多线程程序设计的好处是显而易见，即提高了程序的执行吞吐率。在单CPU单核的计算机上，使用多线程技术，也可以把进程中负责I/O处理、人机交互而常被阻塞的部分与密集计算的部分分开来执行，编写专门的workhorse线程执行密集计算，从而提高了程序的执行效率。 </p>\n</blockquote>\n<p>线程的创建有两种方式，第一种是继承QThread的方式，然后重写run，但是这种方式官方已经不推荐了。官方不推荐的我们就不要这样写了，我们这里讨论的是第二种方式。</p>\n<p>继承QObject ，move到新的线程中。</p>\n<h3 id=\"重写-QObject\"><a href=\"#重写-QObject\" class=\"headerlink\" title=\"重写 QObject\"></a>重写 QObject</h3><pre class=\" language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\" spellcheck=\"true\">// 头文件</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">workThread</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> QObject\n<span class=\"token punctuation\">{</span>\n    Q_OBJECT\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">workThread</span><span class=\"token punctuation\">(</span>QObject<span class=\"token operator\">*</span> parent <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">~</span><span class=\"token function\">workThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> slots<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">start1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsignals<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">workFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">workStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//cpp</span>\nworkThread<span class=\"token operator\">::</span><span class=\"token function\">workThread</span><span class=\"token punctuation\">(</span>QObject<span class=\"token operator\">*</span> parent<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">QObject</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\nworkThread<span class=\"token operator\">::</span><span class=\"token operator\">~</span><span class=\"token function\">workThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> workThread<span class=\"token operator\">::</span><span class=\"token function\">start1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    emit <span class=\"token function\">workStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> workThread<span class=\"token operator\">::</span><span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">qDebug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>i<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    emit <span class=\"token function\">workFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>使用方法</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    QThread<span class=\"token operator\">*</span> m_workerThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">QThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    workThread<span class=\"token operator\">*</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">workThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    worker<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">moveToThread</span><span class=\"token punctuation\">(</span>m_workerThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>m_workerThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>started<span class=\"token punctuation\">,</span> worker<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>workThread<span class=\"token operator\">::</span>start1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>worker<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>workThread<span class=\"token operator\">::</span>workFinished<span class=\"token punctuation\">,</span> m_workerThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>quit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>m_workerThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>finished<span class=\"token punctuation\">,</span> m_workerThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>deleteLater<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//也可以退出释放资源</span>\n<span class=\"token comment\" spellcheck=\"true\">//    connect(qApp, &amp;QApplication::aboutToQuit, worker, &amp;QObject::deleteLater);</span>\n<span class=\"token comment\" spellcheck=\"true\">//    connect(worker, &amp;QObject::destroyed, m_workerThread, &amp;QThread::quit);</span>\n<span class=\"token comment\" spellcheck=\"true\">//    connect(m_workerThread, &amp;QThread::finished, m_workerThread, &amp;QThread::deleteLater);</span></code></pre>\n<p>总结下这样的操作界面是一点都不卡的，因为延迟的操作我们放到新的线程中了。<br>如果需要传递数据的话，可以将数据通过信号槽的方式传递。</p>\n<ul>\n<li>之所以官方不推荐重写QThread也是因为无法使用信号槽</li>\n<li>想继承QThread的话也可以，这个继承QThread的类也需要moveToThread，这种做法不清真，所以不希望大家用。</li>\n</ul>\n<hr>\n<h2 id=\"逻辑5-线程-定时器\"><a href=\"#逻辑5-线程-定时器\" class=\"headerlink\" title=\"逻辑5 线程 + 定时器\"></a>逻辑5 线程 + 定时器</h2><p>实际上，就是逻辑4的进阶版本，再加个定时器，每隔两秒输出当前时间</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TimerThread</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> QObject\n<span class=\"token punctuation\">{</span>\n    Q_OBJECT\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">TimerThread</span><span class=\"token punctuation\">(</span>QObject<span class=\"token operator\">*</span> parent <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">~</span><span class=\"token function\">TimerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsignals<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">workStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">workFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> timerCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nTimerThread<span class=\"token operator\">::</span><span class=\"token function\">TimerThread</span><span class=\"token punctuation\">(</span>QObject<span class=\"token operator\">*</span> parent<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token function\">QObject</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\nTimerThread<span class=\"token operator\">::</span><span class=\"token operator\">~</span><span class=\"token function\">TimerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> TimerThread<span class=\"token operator\">::</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    emit <span class=\"token function\">workStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    QTimer <span class=\"token operator\">*</span>timer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">QTimer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QTimer<span class=\"token operator\">::</span>timeout<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>TimerThread<span class=\"token operator\">::</span>doWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    timer<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> TimerThread<span class=\"token operator\">::</span><span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    timerCount <span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timerCount <span class=\"token operator\">></span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n        emit <span class=\"token function\">workFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">qDebug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>QTime<span class=\"token operator\">::</span><span class=\"token function\">currentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>业务代码在这里</p>\n<pre class=\" language-cpp\"><code class=\"language-cpp\">    <span class=\"token keyword\">auto</span> fTimerThreadStart <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">=</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token keyword\">void</span>\n    <span class=\"token punctuation\">{</span>\n        fiveThread<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ui<span class=\"token operator\">-</span><span class=\"token operator\">></span>threadButton2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QPushButton<span class=\"token operator\">::</span>clicked<span class=\"token punctuation\">,</span> fTimerThreadStart<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>fiveThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>started<span class=\"token punctuation\">,</span> timerObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>TimerThread<span class=\"token operator\">::</span>run<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>timerObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>TimerThread<span class=\"token operator\">::</span>workFinished<span class=\"token punctuation\">,</span> fiveThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>quit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>fiveThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>finished<span class=\"token punctuation\">,</span> fiveThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>QThread<span class=\"token operator\">::</span>deleteLater<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>界面也是灰常丝滑般流畅的。具体的业务逻辑需求可以再想。</p>\n","more":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>我们在写UI文件的时候，有很多情况下，是需要界面来处理业务中某些耗时的操作，这时候如果不处理好界面相关的逻辑的话，主界面就会卡死，这时候就需要我们上多线程了</p>\n<h2 id=\"逻辑1\"><a href=\"#逻辑1\" class=\"headerlink\" title=\"逻辑1\"></a>逻辑1</h2><p>首先上业务上一个很简单的栗子</p>\n<p>比如我们的代码中有这么一个耗时的操作</p>\n<pre><code class=\"cpp\">    // 第一种耗时的操作\n    auto fWhile1 = [] ()\n    {\n        for (int i = 0; i &lt; 1000000; i++)\n        {\n            qDebug()&lt;&lt;i&lt;&lt;endl;\n        }\n    };</code></pre>\n<p>把这个代码绑定到一个按钮事件上</p>\n<pre><code class=\"cpp\">    connect(ui-&gt;pushButton1, &amp;QPushButton::clicked, fWhile1);</code></pre>\n<p>然后点击。发现界面卡死了，很正常，必须得等到这段代码耗时完成之后才能继续操作界面，这段代码是太不友好了，不清真，所以我们要改一下。</p>\n<hr>\n<h2 id=\"逻辑2\"><a href=\"#逻辑2\" class=\"headerlink\" title=\"逻辑2\"></a>逻辑2</h2><p>如何改动，可以看下这个函数</p>\n<pre><code class=\"cpp\">QCoreApplication::processEvents</code></pre>\n<p>来一起看下官网介绍</p>\n<blockquote>\n<p>Processes all pending events for the calling thread according to the specified flags until there are no more events to process.<br>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).<br>In the event that you are running a local loop which calls this function continuously, without an event loop, the DeferredDelete events will not be processed. This can affect the behaviour of widgets, e.g. QToolTip, that rely on DeferredDelete events to function properly. An alternative would be to call sendPostedEvents() from within that local loop.<br>Calling this function processes events only for the calling thread.<br>Note: This function is thread-safe.</p>\n</blockquote>\n<ul>\n<li>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).</li>\n<li>当程序忙于执行长时间操作（例如复制文件）时，您可以偶尔调用此功能。</li>\n</ul>\n<p>我们就暂时就这个（滑稽。<br>接下来可以把代码搞成这种了。</p>\n<pre><code class=\"cpp\">    auto fWhile2 = [] ()\n    {\n        for (int i = 0; i &lt; 1000000; i++)\n        {\n            qDebug()&lt;&lt;i&lt;&lt;endl;\n            QApplication::processEvents();\n        }\n    };\n    connect(ui-&gt;pushButton2, &amp;QPushButton::clicked, fWhile2);</code></pre>\n<p>这种代码在配置不好的机器上实际上还是有点小问题，比如我的小破本子。还是会有点卡的。我觉得用户一般是可以接受这种情况的。</p>\n<hr>\n<h2 id=\"逻辑3\"><a href=\"#逻辑3\" class=\"headerlink\" title=\"逻辑3\"></a>逻辑3</h2><p>实际上这个逻辑还有一个问题，就是如果我的业务代码不是循环该怎么办呢，这时候我们可以用新的类接口</p>\n<pre><code class=\"cpp\">QtConcurrent::run</code></pre>\n<p>这个类。这个类是可以将一个函数放到新的线程里来执行。再加上</p>\n<pre><code class=\"cpp\">QFuture&lt;T&gt;</code></pre>\n<p>这个类，可以控制这个新的线程函数开始，控制，结束。<br>具体可以查看官方文档，我这里就上个简单的栗子</p>\n<pre><code class=\"cpp\">//耗时的操作\nstatic bool function_needmoretime()\n{\n    for (int i = 0; i &lt; 1000000; i++)\n    {\n        qDebug()&lt;&lt;i&lt;&lt;endl;\n    }\n    return true;\n}\n\n    // three\n    auto fWhile3 = [] () -&gt; void\n    {\n        QFuture&lt;bool&gt; future = QtConcurrent::run(function_needmoretime);\n        while(!future.isFinished())\n        {\n            QApplication::processEvents(QEventLoop::AllEvents, 100);\n        }\n    };\n    connect(ui-&gt;pushButton3, &amp;QPushButton::clicked, fWhile3);\n\n</code></pre>\n<p>QFuture + QtConcurrent这个框架非常强大，可以将线程同步异步状态抽象出来，让程序员不用太关心这些。这只是一个最简单的栗子。我的小破本子来运行这个是一点都不卡的。界面依旧如丝滑般流畅。</p>\n<hr>\n<h2 id=\"逻辑4-线程\"><a href=\"#逻辑4-线程\" class=\"headerlink\" title=\"逻辑4-线程\"></a>逻辑4-线程</h2><p>线程基础那种废话我就不多说了。道理大家都懂，我直接上wiki。</p>\n<blockquote>\n<p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在Unix System V及SunOS中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。<br>线程是独立调度和分派的基本单位。线程可以为操作系统内核调度的内核线程，如Win32线程；由用户进程自行调度的用户线程，如Linux平台的POSIX Thread；或者由内核与用户进程，如Windows 7的线程，进行混合调度。<br>同一进程中的多条线程将共享该进程中的全部系统资源，如虚拟地址空间，文件描述符和信号处理等等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。<br>一个进程可以有很多线程，每条线程并行执行不同的任务。<br>在多核或多CPU，或支持Hyper-threading的CPU上使用多线程程序设计的好处是显而易见，即提高了程序的执行吞吐率。在单CPU单核的计算机上，使用多线程技术，也可以把进程中负责I/O处理、人机交互而常被阻塞的部分与密集计算的部分分开来执行，编写专门的workhorse线程执行密集计算，从而提高了程序的执行效率。 </p>\n</blockquote>\n<p>线程的创建有两种方式，第一种是继承QThread的方式，然后重写run，但是这种方式官方已经不推荐了。官方不推荐的我们就不要这样写了，我们这里讨论的是第二种方式。</p>\n<p>继承QObject ，move到新的线程中。</p>\n<h3 id=\"重写-QObject\"><a href=\"#重写-QObject\" class=\"headerlink\" title=\"重写 QObject\"></a>重写 QObject</h3><pre><code class=\"cpp\">// 头文件\nclass workThread : public QObject\n{\n    Q_OBJECT\npublic:\n    workThread(QObject* parent = nullptr);\n    ~workThread();\npublic slots:\n    void start1();\n    void doWork();\nsignals:\n    void workFinished();\n    void workStart();\n};\n\n//cpp\nworkThread::workThread(QObject* parent) : QObject (parent)\n{\n}\nworkThread::~workThread()\n{\n}\nvoid workThread::start1()\n{\n    emit workStart();\n    doWork();\n}\nvoid workThread::doWork()\n{\n    for (int i = 0; i &lt; 1000000; i++)\n    {\n        qDebug()&lt;&lt;i&lt;&lt;endl;\n    }\n    emit workFinished();\n}</code></pre>\n<p>使用方法</p>\n<pre><code class=\"cpp\">    QThread* m_workerThread = new QThread();\n    workThread* worker = new workThread();\n    worker-&gt;moveToThread(m_workerThread);\n\n    connect(m_workerThread, &amp;QThread::started, worker, &amp;workThread::start1);\n    connect(worker, &amp;workThread::workFinished, m_workerThread, &amp;QThread::quit);\n    connect(m_workerThread, &amp;QThread::finished, m_workerThread, &amp;QThread::deleteLater);\n\n    //也可以退出释放资源\n//    connect(qApp, &amp;QApplication::aboutToQuit, worker, &amp;QObject::deleteLater);\n//    connect(worker, &amp;QObject::destroyed, m_workerThread, &amp;QThread::quit);\n//    connect(m_workerThread, &amp;QThread::finished, m_workerThread, &amp;QThread::deleteLater);</code></pre>\n<p>总结下这样的操作界面是一点都不卡的，因为延迟的操作我们放到新的线程中了。<br>如果需要传递数据的话，可以将数据通过信号槽的方式传递。</p>\n<ul>\n<li>之所以官方不推荐重写QThread也是因为无法使用信号槽</li>\n<li>想继承QThread的话也可以，这个继承QThread的类也需要moveToThread，这种做法不清真，所以不希望大家用。</li>\n</ul>\n<hr>\n<h2 id=\"逻辑5-线程-定时器\"><a href=\"#逻辑5-线程-定时器\" class=\"headerlink\" title=\"逻辑5 线程 + 定时器\"></a>逻辑5 线程 + 定时器</h2><p>实际上，就是逻辑4的进阶版本，再加个定时器，每隔两秒输出当前时间</p>\n<pre><code class=\"cpp\">class TimerThread : public QObject\n{\n    Q_OBJECT\npublic:\n    TimerThread(QObject* parent = nullptr);\n    ~TimerThread();\npublic:\n    void run();\n    void doWork();\nsignals:\n    void workStart();\n    void workFinished();\n};\n\nstatic int timerCount = 0;\nTimerThread::TimerThread(QObject* parent): QObject (parent)\n{\n}\nTimerThread::~TimerThread()\n{\n}\nvoid TimerThread::run()\n{\n    emit workStart();\n    QTimer *timer = new QTimer(this);\n    connect(timer, &amp;QTimer::timeout, this, &amp;TimerThread::doWork);\n    timer-&gt;start(2000);\n}\nvoid TimerThread::doWork()\n{\n    timerCount ++;\n    if (timerCount &gt; 100)\n        emit workFinished();\n    qDebug()&lt;&lt;QTime::currentTime()&lt;&lt;endl;\n}</code></pre>\n<p>业务代码在这里</p>\n<pre><code class=\"cpp\">    auto fTimerThreadStart = [=] () -&gt; void\n    {\n        fiveThread-&gt;start();\n    };\n    connect(ui-&gt;threadButton2, &amp;QPushButton::clicked, fTimerThreadStart);\n    connect(fiveThread, &amp;QThread::started, timerObject, &amp;TimerThread::run);\n    connect(timerObject, &amp;TimerThread::workFinished, fiveThread, &amp;QThread::quit);\n    connect(fiveThread, &amp;QThread::finished, fiveThread, &amp;QThread::deleteLater);</code></pre>\n<p>界面也是灰常丝滑般流畅的。具体的业务逻辑需求可以再想。</p>\n","categories":[{"name":"Qt","path":"api/categories/Qt.json"}],"tags":[{"name":"Qt","path":"api/tags/Qt.json"},{"name":"多线程","path":"api/tags/多线程.json"}]}