<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="[转]Deepin开发解决系统字体bug的过程, Qt, C++">
    <meta name="description" content="今天又被 fontconfig 坑到了……仔细想想，半年到一年前我还对 fontconfig 狗屁不通呢，而现在我已经被 fontconfit 坑了有几次了，这印证了一个真理：“只要你足够迟钝，世界就是美好的，一旦你有了某种能力，麻烦就会找">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>[转]Deepin开发解决系统字体bug的过程 | 张小飞</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="张小飞" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">张小飞</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/2020/05/30/qt-ji-chu-jiao-cheng/" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Qt基础教程</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">张小飞</div>
        <div class="logo-desc">
            
            一个CPP开发的博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/2020/05/30/qt-ji-chu-jiao-cheng/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Qt基础教程
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        [转]Deepin开发解决系统字体bug的过程
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Qt/">
                                <span class="chip bg-color">Qt</span>
                            </a>
                        
                            <a href="/tags/deepin/">
                                <span class="chip bg-color">deepin</span>
                            </a>
                        
                            <a href="/tags/freetype/">
                                <span class="chip bg-color">freetype</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Qt/" class="post-category">
                                Qt
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-06-29
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-06-29
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    18 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>今天又被 fontconfig 坑到了……仔细想想，半年到一年前我还对 fontconfig 狗屁不通呢，而现在我已经被 fontconfit 坑了有几次了，这印证了一个真理：“只要你足够迟钝，世界就是美好的，一旦你有了某种能力，麻烦就会找到你”——这只是个玩笑，事实上不管你有没有能力，现实都不会让你好过 😈</p>
<p>在这些坑里面，有两个是跟今天主题相关的，也就是关于WPS中字体名称的两个问题：</p>
<ul>
<li>WPS 字体列表中中文字体在中文环境下不显示中文名（比如系统里面有宋体，列表里面显示 SimSun）；</li>
<li>WPS 设置段落字体（中文字体）后，工具栏显示的字体为英文名（比如你设置一段文字是宋体，但是标题栏显示的仍然是SimSun）</li>
</ul>
<p>这两个问题有点像，但是却不是同一个问题（也不只是WPS有问题，而是WPS对字体的需求比较多）：</p>
<p>第一个问题原先是 论坛用户报告 的（实际上刘老大也报过，不过被自动忽略了😂），论坛用户又报过来以后，大家看用户的报告太详细了，感动得一塌糊涂，顿时解决问题的动力都有了。我也折腾了大半天，不过脑袋里面一直有一个同事的声音：那是字体有问题！我也挺赞同的：盗版的字体，不靠谱很正常……所以，我就考虑能不能给字体做一些别名啥的，比如 SimSun 就叫 宋体……当然了最后就是玩了一下 fontconfig 的配置以后，默默就放弃了。</p>
<p>最后经过 @felixonmars 同学的排查，发现是上游的一个 bug ，而且已经修复，所以赶紧更了一波，解决了这个问题。</p>
<p>本以为皆大欢喜了，今天又有客户报过来 bug，说 Windows 上写好的文档，调整好的字体，跑到deepin下字体就不对了，废了老大的劲儿才又调好，其中就提到了选择方正字库里面的字体，显示的不是中文字体名称的问题。</p>
<p>怎么说呢，幸亏我脑子不好，不记得之前已经解决过中文字体名显示为英文的问题，要不然得跟客户和老板掰扯一会儿，我只记得字体的中英文名字好像是有点问题，所以默默赶紧去看了一下，还真真的有问题。</p>
<p>因为 DDE 并没有设置过多的 fontconfig 配置，所以我相信这不是 DDE 的问题，但是又觉得对于一个文字处理软件来说，如果这么重要的功能都有 BUG，我真不信 WPS 的人还能坐得住，所以就想试一下在 Ubuntu 下 WPS 的这个行为是否正确。刚好年前 ElementryOS 发新版的时候尝鲜装了一个在测试机器上，所以很快切进去下了一个 WPS 安装上，从一个正版的网站上下载了一个盗版的宋体，试了一下，果然踏马的是好的……</p>
<p>理性的我用事实证明了感性的我是错误的，气氛一度很尴尬。</p>
<p>更让人尴尬的是，我也不知道这是怎么回事。但是，无巧不成书，就在这种尴尬氛围的笼罩下，我鬼使神差地在 ElementryOS （太长了，下面简称 EOS ）上运行了 fc-match 宋体 这个命令，而且很神奇的发现输出的 simsun.ttf: “宋体” “Regular” 跟 deepin 下同样命令输出的 simsun.ttf: “SimSun” “Regular” 不太一样，这可把我乐坏了——要知道一个稍微复杂点的图形软件，打开 fontconfig 的调试以后，输出就是很可怕的，更别说 WPS！别问我是怎么知道的，回忆起来都是泪。但是现在使用 fc-match 就能重现的问题（我打心底认为这俩是同一个问题），调试起来就比较简单了。</p>
<p>fontconfig 本身为了方便程序调试，内建了一些调试项，可以通过环境变量 FC_DEBUG 控制：</p>
<pre class=" language-cpp"><code class="language-cpp">Name Value Meaning
  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
  MATCH <span class="token number">1</span> Brief information about font matching
  MATCHV <span class="token number">2</span> Extensive font matching information
  EDIT <span class="token number">4</span> Monitor match<span class="token operator">/</span>test<span class="token operator">/</span>edit execution
  FONTSET <span class="token number">8</span> Track loading of font information at startup
  CACHE <span class="token number">16</span> Watch cache files being written
  CACHEV <span class="token number">32</span> Extensive cache file writing information
  PARSE <span class="token function">64</span> <span class="token punctuation">(</span>no longer in use<span class="token punctuation">)</span>
  SCAN <span class="token number">128</span> Watch font files being scanned to build caches
  SCANV <span class="token number">256</span> Verbose font file scanning information
  MEMORY <span class="token number">512</span> Monitor fontconfig memory usage
  CONFIG <span class="token number">1024</span> Monitor which config files are loaded
  LANGSET <span class="token number">2048</span> Dump <span class="token keyword">char</span> sets used to construct lang values
  MATCH2 <span class="token number">4096</span> Display font<span class="token operator">-</span>matching transformation in patterns</code></pre>
<p>我们只需要最简略的匹配信息就可以了，所以：</p>
<pre class=" language-cpp"><code class="language-cpp">$ FC_DEBUG<span class="token operator">=</span><span class="token number">1</span> fc<span class="token operator">-</span>match 宋体
FC_DEBUG<span class="token operator">=</span><span class="token number">1</span>
Match Pattern has <span class="token number">25</span> <span class="token function">elts</span> <span class="token punctuation">(</span>size <span class="token number">32</span><span class="token punctuation">)</span>
    family<span class="token operator">:</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans CJK SC"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    familylang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    stylelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fullnamelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    slant<span class="token operator">:</span> <span class="token function">0</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    weight<span class="token operator">:</span> <span class="token function">80</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    width<span class="token operator">:</span> <span class="token function">100</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    size<span class="token operator">:</span> <span class="token function">12</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    pixelsize<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">.</span><span class="token function">5</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    hintstyle<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    hinting<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    verticallayout<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    autohint<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    globaladvance<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    dpi<span class="token operator">:</span> <span class="token function">75</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    scale<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    lang<span class="token operator">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fontversion<span class="token operator">:</span> <span class="token function">2147483647</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    embeddedbitmap<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    decorative<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    lcdfilter<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    namelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    prgname<span class="token operator">:</span> <span class="token string">"fc-match"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    symbol<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    variable<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
Best score <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1e+99</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">2.14735e+12</span>
Pattern has <span class="token number">25</span> <span class="token function">elts</span> <span class="token punctuation">(</span>size <span class="token number">25</span><span class="token punctuation">)</span>
    family<span class="token operator">:</span> <span class="token string">"SimSun"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    familylang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token string">"zh-cn"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    style<span class="token operator">:</span> <span class="token string">"Regular"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    stylelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fullname<span class="token operator">:</span> <span class="token string">"SimSun"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fullnamelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token string">"zh-cn"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    slant<span class="token operator">:</span> <span class="token function">0</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    weight<span class="token operator">:</span> <span class="token function">80</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    width<span class="token operator">:</span> <span class="token function">100</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    spacing<span class="token operator">:</span> <span class="token function">90</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    foundry<span class="token operator">:</span> <span class="token string">"ZYEC"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    file<span class="token operator">:</span> <span class="token string">"/home/hualet/.fonts/simsun.ttf"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    index<span class="token operator">:</span> <span class="token function">0</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    outline<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    scalable<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    charset<span class="token operator">:</span> 
    <span class="token number">0000</span><span class="token operator">:</span> <span class="token number">00000000</span> ffffffff ffffffff ffffffff <span class="token number">00000000</span> ffffffff ffffffff ffffffff
    <span class="token number">0001</span><span class="token operator">:</span> <span class="token number">08080002</span> <span class="token number">00000800</span> 000c2110 <span class="token number">01000803</span> <span class="token number">00040000</span> <span class="token number">00000000</span> <span class="token number">15554000</span> <span class="token number">00000000</span>
    <span class="token number">0002</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00020000</span> <span class="token number">00000002</span> <span class="token number">00000000</span> <span class="token number">00000000</span> 12000ec0 <span class="token number">00000000</span>
    <span class="token number">0003</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> fffe0000 fffe03fb 000003fb <span class="token number">00000000</span>
    <span class="token number">0004</span><span class="token operator">:</span> ffff0002 ffffffff <span class="token number">0002ffff</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0020</span><span class="token operator">:</span> <span class="token number">77790000</span> 0e2d0067 <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00001000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0021</span><span class="token operator">:</span> <span class="token number">00400228</span> <span class="token number">00000006</span> <span class="token number">00000000</span> 03ff0fff 03cf0000 <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0022</span><span class="token operator">:</span> e4228100 20f04fa9 <span class="token number">00041100</span> 0000c0f3 <span class="token number">02200000</span> <span class="token number">80000020</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0023</span><span class="token operator">:</span> <span class="token number">00040000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0024</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> fff003ff <span class="token number">0fffffff</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0025</span><span class="token operator">:</span> ffffffff ffffffff ffff0fff <span class="token number">000fffff</span> 0038fffe 300c0003 0000c8c0 0000003c
    <span class="token number">0026</span><span class="token operator">:</span> <span class="token number">00000260</span> <span class="token number">00000000</span> <span class="token number">00000005</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0030</span><span class="token operator">:</span> 60ffffef 000003fe fffffffe ffffffff <span class="token number">780fffff</span> fffffffe ffffffff <span class="token number">707fffff</span>
    <span class="token number">0031</span><span class="token operator">:</span> ffffffe0 <span class="token number">000003ff</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0032</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">000203ff</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000008</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">0033</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> 7000c000 <span class="token number">00000002</span> <span class="token number">00264010</span> <span class="token number">00000000</span>
    004e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">004f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0050</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0051</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0052</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0053</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0054</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0055</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0056</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0057</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0058</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0059</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    005a<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    005b<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    005c<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    005d<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    005e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">005f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0060</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0061</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0062</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0063</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0064</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0065</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0066</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0067</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0068</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0069</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    006a<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    006b<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    006c<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    006d<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    006e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">006f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0070</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0071</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0072</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0073</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0074</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0075</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0076</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0077</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0078</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0079</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    007a<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    007b<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    007c<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    007d<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    007e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">007f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0080</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0081</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0082</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0083</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0084</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0085</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0086</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0087</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0088</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0089</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    008a<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    008b<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    008c<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    008d<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    008e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">008f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0090</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0091</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0092</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0093</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0094</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0095</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0096</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0097</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0098</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">0099</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    009a<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    009b<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    009c<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    009d<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    009e<span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
    <span class="token number">009f</span><span class="token operator">:</span> ffffffff ffffffff ffffffff ffffffff ffffffff <span class="token number">0000003f</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">00e7</span><span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000180</span> 000fff80
    <span class="token number">00e8</span><span class="token operator">:</span> ffe00000 ffffffff ffffffff <span class="token number">0000001f</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    00f9<span class="token operator">:</span> <span class="token number">00000000</span> <span class="token number">00001000</span> <span class="token number">00000000</span> <span class="token number">02000000</span> <span class="token number">00200000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00020080</span>
    00fa<span class="token operator">:</span> 811af000 0000039b <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    00fe<span class="token operator">:</span> <span class="token number">00000000</span> fffb0000 fef7fe1f 00000f7f <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span>
    <span class="token number">00ff</span><span class="token operator">:</span> fffffffe ffffffff <span class="token number">7fffffff</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token function">0000003f</span>
<span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    lang<span class="token operator">:</span> aa<span class="token operator">|</span>ay<span class="token operator">|</span>bg<span class="token operator">|</span>bi<span class="token operator">|</span>br<span class="token operator">|</span>ch<span class="token operator">|</span>co<span class="token operator">|</span>da<span class="token operator">|</span>de<span class="token operator">|</span>en<span class="token operator">|</span>es<span class="token operator">|</span>eu<span class="token operator">|</span>fj<span class="token operator">|</span>fo<span class="token operator">|</span>fr<span class="token operator">|</span>fur<span class="token operator">|</span>fy<span class="token operator">|</span>gd<span class="token operator">|</span>gl<span class="token operator">|</span>gv<span class="token operator">|</span>ho<span class="token operator">|</span>ia<span class="token operator">|</span>id<span class="token operator">|</span>ie<span class="token operator">|</span>io<span class="token operator">|</span>is<span class="token operator">|</span>it<span class="token operator">|</span>kum<span class="token operator">|</span>lb<span class="token operator">|</span>mg<span class="token operator">|</span>nb<span class="token operator">|</span>nds<span class="token operator">|</span>nl<span class="token operator">|</span>nn<span class="token operator">|</span>no<span class="token operator">|</span>nr<span class="token operator">|</span>nso<span class="token operator">|</span>oc<span class="token operator">|</span>om<span class="token operator">|</span>os<span class="token operator">|</span>pt<span class="token operator">|</span>rm<span class="token operator">|</span>ru<span class="token operator">|</span>sel<span class="token operator">|</span>sma<span class="token operator">|</span>smj<span class="token operator">|</span>so<span class="token operator">|</span>sq<span class="token operator">|</span>ss<span class="token operator">|</span>st<span class="token operator">|</span>sv<span class="token operator">|</span>sw<span class="token operator">|</span>tl<span class="token operator">|</span>tn<span class="token operator">|</span>ts<span class="token operator">|</span>uz<span class="token operator">|</span>vo<span class="token operator">|</span>wa<span class="token operator">|</span>xh<span class="token operator">|</span>yap<span class="token operator">|</span>zh<span class="token operator">-</span>cn<span class="token operator">|</span>zh<span class="token operator">-</span>sg<span class="token operator">|</span>zu<span class="token operator">|</span>an<span class="token operator">|</span>fil<span class="token operator">|</span>ht<span class="token operator">|</span>jv<span class="token operator">|</span>kj<span class="token operator">|</span>kwm<span class="token operator">|</span>li<span class="token operator">|</span>ms<span class="token operator">|</span>ng<span class="token operator">|</span>pap<span class="token operator">-</span>an<span class="token operator">|</span>pap<span class="token operator">-</span>aw<span class="token operator">|</span>rn<span class="token operator">|</span>rw<span class="token operator">|</span>sc<span class="token operator">|</span>sg<span class="token operator">|</span>sn<span class="token operator">|</span>su<span class="token operator">|</span><span class="token function">za</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fontversion<span class="token operator">:</span> <span class="token function">131072</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    capability<span class="token operator">:</span> <span class="token string">"otlayout:hani"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fontformat<span class="token operator">:</span> <span class="token string">"TrueType"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    decorative<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    postscriptname<span class="token operator">:</span> <span class="token string">"SimSun"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    color<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    symbol<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    variable<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
simsun<span class="token punctuation">.</span>ttf<span class="token operator">:</span> <span class="token string">"SimSun"</span> <span class="token string">"Regular"</span></code></pre>
<p>因为以前调 fontconfig 的经验，我模模糊糊知道那个 familylang 是控制 family 也就是字体名显示的语言的，所以看到</p>
<pre class=" language-shell"><code class="language-shell">familylang: "en"(s) "en-us"(w)</code></pre>
<p>这行以后，大致能确定应该是系统某个配置出了问题让 fontconfig 误以为语言环境是英文。看了一下环境变量，没发现哪个是设置英文的，所以只能去看代码了。<br>下了 fontconfig 的源码，搜了一下关键字 familylang ，猜测这个属性应该是通过操纵 FC_FAMILYLANG_OBJECT ，再次搜索：</p>
<pre class=" language-shell"><code class="language-shell"> $ rg -i FC_FAMILYLANG_OBJECT
src/fcmatch.c
380: case FC_FAMILYLANG_OBJECT:
551: if (fe->object == FC_FAMILYLANG_OBJECT ||
565: FC_ASSERT_STATIC ((FC_FAMILY_OBJECT + 1) == FC_FAMILYLANG_OBJECT);
695: pe->object != FC_FAMILYLANG_OBJECT &&
src/fclist.c
430: familyidx = FcGetDefaultObjectLangIndex (font, FC_FAMILYLANG_OBJECT, lang);
src/fcfreetype.c
1671: while (FcPatternObjectGetString (pat, FC_FAMILYLANG_OBJECT, n, &familylang) == FcResultMatch)
src/fcdefault.c
316: if (!FcPatternFindObjectIter (pattern, &iter, FC_FAMILYLANG_OBJECT))
318: FcPatternObjectAdd (pattern, FC_FAMILYLANG_OBJECT, namelang, FcTrue);
319: FcPatternObjectAddWithBinding (pattern, FC_FAMILYLANG_OBJECT, v2, FcValueBindingWeak, FcTrue);</code></pre>
<p>发现其中只有 fcdefault.c 里面有执行 FcPatternObjectAdd 这个操作像是在修改这个属性，其他地方明显都只是读取，刚好 fc-match/fc-match.c 里面也有调用这个函数，所以仔细看了一下这个函数，从逻辑上看意思是 familylang 如果没有设置，就会从 namelang 属性继承，然后我忽然发现 fc-match 的帮助里面写得位置参数概念上叫 pattern ，难道就对应 FcPattern，那它应该也可以指定 familylang 咯？网上搜寻了一番，发现可以 fc-match 宋体:familylang=zh-cn，果然输出正常的中文名。这算是一个小插曲吧。</p>
<p>接着 namelang 属性说，这个属性是从一个叫 FcGetDefaultLang 的函数处获取，我心想总算是要到头了，然而发现从函数的实现来看，这个函数会从 FC_LANG、LC_ALL、LC_CTYPE和LANG这些环境变量里面挨个读取默认的语言（后来发现直接 man FcGetDefaultlangs 就可以看到），看起来没毛病呀。</p>
<p>写了个测试程序：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fontconfig/fontconfig.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FcStrSet <span class="token operator">*</span>langs <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    langs <span class="token operator">=</span> <span class="token function">FcGetDefaultLangs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>langs<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        FcChar8 <span class="token operator">*</span>lang <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        FcStrList <span class="token operator">*</span>lang_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        lang_list <span class="token operator">=</span> <span class="token function">FcStrListCreate</span><span class="token punctuation">(</span>langs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FcStrListFirst</span><span class="token punctuation">(</span>lang_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>lang <span class="token operator">=</span> <span class="token function">FcStrListNext</span><span class="token punctuation">(</span>lang_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> lang<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>编译执行，输出 zh-CN ，666</p>
<p>中间尝试了使用 gdb 在 fc-match.c中调用 FcDefaultSubstitute 的部分加断点，但是死活无法跳入函数体里面，直接在函数里面响应的行数处断点，直接无效……撞鬼了</p>
<p>没办法了，只能改代码了，找了找代码里面的 log 模块叫 fcdbg.c ，我本来还说从 FcPattern 里面读取属性有点麻烦，又不熟悉代码，但是意外地找到一个 FcPatternPrint ，这下连继续研究下去的动力都没有了，赶紧加代码打印，分别在 FcConfigSubstitute 和 FcDefaultSubstitute 前后加了打印看对 pat 的代码：</p>
<pre class=" language-cpp"><code class="language-cpp">    <span class="token function">FcPatternPrint</span><span class="token punctuation">(</span>pat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FcConfigSubstitute</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pat<span class="token punctuation">,</span> FcMatchPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FcPatternPrint</span><span class="token punctuation">(</span>pat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FcDefaultSubstitute</span> <span class="token punctuation">(</span>pat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FcPatternPrint</span><span class="token punctuation">(</span>pat<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>输入</p>
<pre class=" language-cpp"><code class="language-cpp">$ <span class="token punctuation">.</span><span class="token operator">/</span>fc<span class="token operator">-</span>match 宋体
Pattern has <span class="token number">1</span> <span class="token function">elts</span> <span class="token punctuation">(</span>size <span class="token number">16</span><span class="token punctuation">)</span>
    family<span class="token operator">:</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
Pattern has <span class="token number">6</span> <span class="token function">elts</span> <span class="token punctuation">(</span>size <span class="token number">16</span><span class="token punctuation">)</span>
    family<span class="token operator">:</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans CJK SC"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    hintstyle<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    lang<span class="token operator">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    lcdfilter<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    namelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    prgname<span class="token operator">:</span> <span class="token string">"fc-match"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
Pattern has <span class="token number">25</span> <span class="token function">elts</span> <span class="token punctuation">(</span>size <span class="token number">32</span><span class="token punctuation">)</span>
    family<span class="token operator">:</span> <span class="token string">"宋体"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans CJK SC"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"Noto Sans"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    familylang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    stylelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fullnamelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token string">"en-us"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    slant<span class="token operator">:</span> <span class="token function">0</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    weight<span class="token operator">:</span> <span class="token function">80</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    width<span class="token operator">:</span> <span class="token function">100</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    size<span class="token operator">:</span> <span class="token function">12</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    pixelsize<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">.</span><span class="token function">5</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    hintstyle<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    hinting<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    verticallayout<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    autohint<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    globaladvance<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    dpi<span class="token operator">:</span> <span class="token function">75</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    scale<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    lang<span class="token operator">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    fontversion<span class="token operator">:</span> <span class="token function">2147483647</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    embeddedbitmap<span class="token operator">:</span> <span class="token function">True</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    decorative<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    lcdfilter<span class="token operator">:</span> <span class="token function">1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    namelang<span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
    prgname<span class="token operator">:</span> <span class="token string">"fc-match"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    symbol<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    variable<span class="token operator">:</span> <span class="token function">False</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
simsun<span class="token punctuation">.</span>ttf<span class="token operator">:</span> <span class="token string">"SimSun"</span> <span class="token string">"Regular"</span></code></pre>
<p>可以确认是 FcConfigSubstitute 函数里面给 pat 设置了 en 的 namelang，那之后在 FcDefaultSubstitute 中 familylang 就从 namelang 继承了 en ，又加上了 en-us ，变成了我们看到的 “en”，”en-us” 。看函数名， FcConfigSubstitute 应该就是读取了配置文件，然后做了什么修改，至于怎么改的我也不知道。</p>
<p>这时候我偷懒症犯了，没有去看代码了（看着略复杂），我发现新版 fontconfig 多了一个工具叫 fc-conflist 能列出来 fontconfig 加载的所有配置文件列表，通过这个命令我发现系统里面的配置文件主要放在 /etc/fonts 和 /usr/share/fontconfig ，然后就用 rg 去里面搜关键字 lang 了，排除其中 <test> 的行，还真发现一个叫 /usr/share/conf.avail/15-assign-lang-en.conf 的文件里面有 edit namelang 这个属性，在此之前，我都不知道还有 edit 这种操作……我也更不信这个问题会出在 fontconfig 的配置上。</test></p>
<pre class=" language-shell"><code class="language-shell">$ dpkg -S conf.avail/15-assign-lang-en.conf
deepin-default-settings: /usr/share/fontconfig/conf.avail/15-assign-lang-en.conf</code></pre>
<p>事实证明，这个配置文件还真是 deepin 提供的……</p>
<p>本来想搞清楚之前为什么要做这个的，但是提交信息太简单了，没有提供相关线索，猜测应该是以前有些字体名称会乱码——字体名称需要特殊字体的支持，然而系统（终端）的字体不支持这种字体的字体名，为了解决乱码，默认使用英文输出字体名称 😅</p>
<p>不过有了 Noto 这种问题应该就很少了，所以狠心删掉了这个配置：提交。</p>
<p>结合这两个问题，猜测 WPS 字体设置分两个部分，一部分是从系统获取字体列表，这个部分是从 Qt 拿的，用的 Qt 提供的字体名（中文），第二部分是从这个字体名拿到系统中匹配度最高的字体，应该是通过 libfontconfig 直接做得（deepin下英文），然后再把这个字体设置给实际的文档，工具栏中显示的也就是这个名字。总之，人家又不开源，瞎猜一下图个开心咯。</p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://cryfeifei.top" rel="external nofollow noreferrer">张小飞</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://cryfeifei.top/2020/06/29/zhuan-deepin-kai-fa-jie-jue-xi-tong-zi-ti-bug-de-guo-cheng/">https://cryfeifei.top/2020/06/29/zhuan-deepin-kai-fa-jie-jue-xi-tong-zi-ti-bug-de-guo-cheng/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://cryfeifei.top" target="_blank">张小飞</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Qt/">
                                    <span class="chip bg-color">Qt</span>
                                </a>
                            
                                <a href="/tags/deepin/">
                                    <span class="chip bg-color">deepin</span>
                                </a>
                            
                                <a href="/tags/freetype/">
                                    <span class="chip bg-color">freetype</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/06/29/qt-zhong-ui-wen-jian-shi-ru-he-zhuan-cheng-c-wen-jian-de-uic-gong-cheng-qt-yuan-ma-pou-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="Qt中 UI文件是如何转成C++文件的—UIC工程(Qt源码剖析)">
                        
                        <span class="card-title">Qt中 UI文件是如何转成C++文件的—UIC工程(Qt源码剖析)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            序UI文件为标准的XMLh文件为标准的Qt语法的文件。先思考一分钟：如何让你来设计，你如何做转化？
过程其实过程很简单读取ui文件（即xml） -&gt; 经过一些规则的变化-&gt; 输出.h文件
实际上只是单纯的规则变化 - 字符串变化
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-06-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Qt/" class="post-category">
                                    Qt
                                </a>
                            
                            <a href="/categories/Qt/Qt%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" class="post-category">
                                    Qt源码剖析
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Qt/">
                        <span class="chip bg-color">Qt</span>
                    </a>
                    
                    <a href="/tags/Qt%E6%BA%90%E7%A0%81/">
                        <span class="chip bg-color">Qt源码</span>
                    </a>
                    
                    <a href="/tags/Qt%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">
                        <span class="chip bg-color">Qt源码剖析</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/29/qt-de-ji-ben-gai-nian-wiki/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="Qt的基本概念-WIKI">
                        
                        <span class="card-title">Qt的基本概念-WIKI</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简述wikiQt（/ˈkjuːt/，发音同“cute”[4][5][6]）是一个跨平台的C++应用程序开发框架。广泛用于开发GUI程序，这种情况下又被称为部件工具箱。也可用于开发非GUI程序，比如控制台工具和服务器。Qt使用于OPIE、Sk
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Qt/" class="post-category">
                                    Qt
                                </a>
                            
                            <a href="/categories/Qt/Qt%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/" class="post-category">
                                    Qt基础教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Qt/">
                        <span class="chip bg-color">Qt</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 张小飞<br />'
            + '文章作者: 张小飞<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">年份</span>
            <a href="https://cryfeifei.top" target="_blank">张小飞</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">47.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "5";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/cryfeifei" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:zhangpf0313@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
