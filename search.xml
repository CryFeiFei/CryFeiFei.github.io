<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>QFileSystemWatcher源码剖析(Linux)</title>
      <link href="/2020/06/27/qfilesystemwatcher-yuan-ma-pou-xi-linux/"/>
      <url>/2020/06/27/qfilesystemwatcher-yuan-ma-pou-xi-linux/</url>
      
        <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>QFileSystemWatcher的作用是监视本地文件夹的变化以及文件的变化。</p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>QFileSystemWatcher的实现类是QFileSystemWatcherPrivate。 其中QFileSystemWatcherPrivate中的关键成员变量QFileSystemWatcherEngine用于监视目录以及文件的变化，发送信号给QFileystemWatcher。其中QFileSystemWatcherEngine派生了三个类。</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">QFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QThread</code></pre><p>其派生的子类三种类型分别为</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// 这个用于监控Dir的变化</span><span class="token keyword">class</span> <span class="token class-name">QDnotifyFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QFileSystemWatcherEngine<span class="token comment" spellcheck="true">// 这个外部没有暴露对应的变化接口，但是检测其它类型的目录变化时我们会用到</span><span class="token keyword">class</span> <span class="token class-name">QPollingFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QFileSystemWatcherEngine<span class="token comment" spellcheck="true">// 这个用于检测文件类型的变化</span><span class="token keyword">class</span> <span class="token class-name">QInotifyFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QFileSystemWatcherEngine</code></pre><h2 id="QInotifyFileSystemWatcherEngine"><a href="#QInotifyFileSystemWatcherEngine" class="headerlink" title="QInotifyFileSystemWatcherEngine"></a>QInotifyFileSystemWatcherEngine</h2><p>QInotifyFileSystemWatcherEngine用于监视文件的变化。</p><p>// 太长可以忽略，这是详细实现</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//media/zhangpf/workspace1/Qt4.8.7/qt-everywhere-opensource-src-4.8.7/src/corelib/io/qfilesystemwatcher_inotify_p.h</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qfilesystemwatcher_p.h"</span></span><span class="token macro property">#<span class="token directive keyword">ifndef</span> QT_NO_FILESYSTEMWATCHER</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qhash.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qmutex.h></span></span>QT_BEGIN_NAMESPACE<span class="token keyword">class</span> <span class="token class-name">QInotifyFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QFileSystemWatcherEngine<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token operator">~</span><span class="token function">QInotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> QInotifyFileSystemWatcherEngine <span class="token operator">*</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//单例模式</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList <span class="token function">addPaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList <span class="token function">removePaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> Q_SLOTS<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">readFromInotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">QInotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> inotifyFd<span class="token punctuation">;</span>    QMutex mutex<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span>QString<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> pathToID<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> QString<span class="token operator">></span> idToPath<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>QT_END_NAMESPACE<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">// QT_NO_FILESYSTEMWATCHER</span><span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">// QFILESYSTEMWATCHER_INOTIFY_P_H</span><span class="token comment" spellcheck="true">// cpp</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/inotify.h></span></span><span class="token macro property">#<span class="token directive keyword">endif</span></span>QT_BEGIN_NAMESPACEQInotifyFileSystemWatcherEngine <span class="token operator">*</span>QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">ifdef</span> IN_CLOEXEC</span>    fd <span class="token operator">=</span> <span class="token function">inotify_init1</span><span class="token punctuation">(</span>IN_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        fd <span class="token operator">=</span> <span class="token function">inotify_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">QInotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">QInotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">inotifyFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">moveToThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token operator">~</span><span class="token function">QInotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">foreach</span> <span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> pathToID<span class="token punctuation">)</span>        <span class="token function">inotify_rm_watch</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> id <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>id <span class="token operator">:</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QSocketNotifier <span class="token function">sn</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> QSocketNotifier<span class="token operator">::</span>Read<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//通过socket来监视文件的变化，替代thread一个很好的方式</span>    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sn<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">activated</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">readFromInotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>QStringList QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">addPaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span>                                                      QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span>                                                      QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList p <span class="token operator">=</span> paths<span class="token punctuation">;</span>    QMutableListIterator<span class="token operator">&lt;</span>QString<span class="token operator">></span> <span class="token function">it</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QString path <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        QFileInfo <span class="token function">fi</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">bool</span> isDir <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">isDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">contains</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token operator">-</span><span class="token operator">></span><span class="token function">contains</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> wd <span class="token operator">=</span> <span class="token function">inotify_add_watch</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span>                                   QFile<span class="token operator">::</span><span class="token function">encodeName</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>                                   <span class="token punctuation">(</span>isDir                                    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token number">0</span>                                       <span class="token operator">|</span> IN_ATTRIB                                       <span class="token operator">|</span> IN_MOVE                                       <span class="token operator">|</span> IN_CREATE                                       <span class="token operator">|</span> IN_DELETE                                       <span class="token operator">|</span> IN_DELETE_SELF                                       <span class="token punctuation">)</span>                                    <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span>                                       <span class="token operator">|</span> IN_ATTRIB                                       <span class="token operator">|</span> IN_MODIFY                                       <span class="token operator">|</span> IN_MOVE                                       <span class="token operator">|</span> IN_MOVE_SELF                                       <span class="token operator">|</span> IN_DELETE_SELF                                       <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>wd <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"QInotifyFileSystemWatcherEngine::addPaths: inotify_add_watch failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> id <span class="token operator">=</span> isDir <span class="token operator">?</span> <span class="token operator">-</span>wd <span class="token operator">:</span> wd<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">append</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            files<span class="token operator">-</span><span class="token operator">></span><span class="token function">append</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        pathToID<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>        idToPath<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">}</span>QStringList QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">removePaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span>                                                         QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span>                                                         QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList p <span class="token operator">=</span> paths<span class="token punctuation">;</span>    QMutableListIterator<span class="token operator">&lt;</span>QString<span class="token operator">></span> <span class="token function">it</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QString path <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> id <span class="token operator">=</span> pathToID<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        QString x <span class="token operator">=</span> idToPath<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> x <span class="token operator">!=</span> path<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> wd <span class="token operator">=</span> id <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>id <span class="token operator">:</span> id<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// qDebug() &lt;&lt; "removing watch for path" &lt;&lt; path &lt;&lt; "wd" &lt;&lt; wd;</span>        <span class="token function">inotify_rm_watch</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> wd<span class="token punctuation">)</span><span class="token punctuation">;</span>        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeAll</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            files<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeAll</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QInotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">readFromInotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//主要是通过unix库函数来获取文件对应的详细信息。再跟addpath实现中缓存下来的信息做对比，来检测文件的变化。</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// qDebug() &lt;&lt; "QInotifyFileSystemWatcherEngine::readFromInotify";</span>    <span class="token keyword">int</span> buffSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">ioctl</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> FIONREAD<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>buffSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    QVarLengthArray<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token operator">></span> <span class="token function">buffer</span><span class="token punctuation">(</span>buffSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    buffSize <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>at <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> end <span class="token operator">=</span> at <span class="token operator">+</span> buffSize<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> inotify_event <span class="token operator">*</span><span class="token operator">></span> eventForId<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>at <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>        inotify_event <span class="token operator">*</span>event <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>inotify_event <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>at<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventForId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>event<span class="token operator">-</span><span class="token operator">></span>wd<span class="token punctuation">)</span><span class="token punctuation">)</span>            eventForId<span class="token punctuation">[</span>event<span class="token operator">-</span><span class="token operator">></span>wd<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>mask <span class="token operator">|</span><span class="token operator">=</span> event<span class="token operator">-</span><span class="token operator">></span>mask<span class="token punctuation">;</span>        <span class="token keyword">else</span>            eventForId<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>event<span class="token operator">-</span><span class="token operator">></span>wd<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>        at <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>inotify_event<span class="token punctuation">)</span> <span class="token operator">+</span> event<span class="token operator">-</span><span class="token operator">></span>len<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> inotify_event <span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>const_iterator it <span class="token operator">=</span> eventForId<span class="token punctuation">.</span><span class="token function">constBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> eventForId<span class="token punctuation">.</span><span class="token function">constEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> inotify_event <span class="token operator">&amp;</span>event <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>it<span class="token punctuation">;</span>        <span class="token operator">++</span>it<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// qDebug() &lt;&lt; "inotify event, wd" &lt;&lt; event.wd &lt;&lt; "mask" &lt;&lt; hex &lt;&lt; event.mask;</span>        <span class="token keyword">int</span> id <span class="token operator">=</span> event<span class="token punctuation">.</span>wd<span class="token punctuation">;</span>        QString path <span class="token operator">=</span> idToPath<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// perhaps a directory?</span>            id <span class="token operator">=</span> <span class="token operator">-</span>id<span class="token punctuation">;</span>            path <span class="token operator">=</span> idToPath<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// qDebug() &lt;&lt; "event for path" &lt;&lt; path;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>mask <span class="token operator">&amp;</span> <span class="token punctuation">(</span>IN_DELETE_SELF <span class="token operator">|</span> IN_MOVE_SELF <span class="token operator">|</span> IN_UNMOUNT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            pathToID<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>            idToPath<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">inotify_rm_watch</span><span class="token punctuation">(</span>inotifyFd<span class="token punctuation">,</span> event<span class="token punctuation">.</span>wd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                emit <span class="token function">directoryChanged</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                emit <span class="token function">fileChanged</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                emit <span class="token function">directoryChanged</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                emit <span class="token function">fileChanged</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>QT_END_NAMESPACE<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">// QT_NO_FILESYSTEMWATCHER</span></code></pre><p>这是一个单例模式，里边的核心代码其实就是讲的是Inotify相关的函数。其中的关键的点，我已经打上备注。这个类中的主要实现是Linux下的Inotify的使用相关。</p><h2 id="Inotify"><a href="#Inotify" class="headerlink" title="Inotify"></a>Inotify</h2><p>Inotify简单的来讲是在Linux下监视文件与文件夹的相关机制，本来想自己写这一部分教程的，可是有一篇文章写的太好了，忍不住给大家分享了。<br><a href="https://www.ibm.com/developerworks/cn/linux/l-inotify/" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-inotify/</a> 看完这一篇文章之后我觉得你对Linux下如何监视文件应该有了解了，甚至可以自己封装一个类给大家用。</p><h1 id="文件夹的检测变化实现类-QDnotifyFileSystemWatcherEngine"><a href="#文件夹的检测变化实现类-QDnotifyFileSystemWatcherEngine" class="headerlink" title="文件夹的检测变化实现类 QDnotifyFileSystemWatcherEngine"></a>文件夹的检测变化实现类 QDnotifyFileSystemWatcherEngine</h1><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">QDnotifyFileSystemWatcherEngine</span> <span class="token operator">:</span> <span class="token keyword">public</span> QFileSystemWatcherEngine<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">QDnotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> QDnotifyFileSystemWatcherEngine <span class="token operator">*</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList <span class="token function">addPaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList <span class="token function">removePaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> Q_SLOTS<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token comment" spellcheck="true">//这个结构体比较关键</span>    <span class="token keyword">struct</span> Directory <span class="token punctuation">{</span>        <span class="token function">Directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">parentFd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isMonitored</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token function">Directory</span><span class="token punctuation">(</span><span class="token keyword">const</span> Directory <span class="token operator">&amp;</span>o<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">path</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">fd</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">parentFd</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>parentFd<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">isMonitored</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>isMonitored<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">files</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        QString path<span class="token punctuation">;</span>        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>        <span class="token keyword">int</span> parentFd<span class="token punctuation">;</span>        <span class="token keyword">bool</span> isMonitored<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//这个结构体也比较关键</span>        <span class="token keyword">struct</span> File <span class="token punctuation">{</span>            <span class="token function">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ownerId</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">groupId</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">permissions</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>            <span class="token function">File</span><span class="token punctuation">(</span><span class="token keyword">const</span> File <span class="token operator">&amp;</span>o<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">path</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">ownerId</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>ownerId<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">groupId</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>groupId<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">permissions</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>permissions<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">lastWrite</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>lastWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            QString path<span class="token punctuation">;</span>            <span class="token keyword">bool</span> <span class="token function">updateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            uint ownerId<span class="token punctuation">;</span>            uint groupId<span class="token punctuation">;</span>            QFile<span class="token operator">::</span>Permissions permissions<span class="token punctuation">;</span>            QDateTime lastWrite<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        QList<span class="token operator">&lt;</span>File<span class="token operator">></span> files<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">QDnotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QMutex mutex<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span>QString<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> pathToFD<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Directory<span class="token operator">></span> fdToDirectory<span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> parentToFD<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//cpp</span>QDnotifySignalThread<span class="token operator">::</span><span class="token function">QDnotifySignalThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">isExecing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">moveToThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">qt_safe_pipe</span><span class="token punctuation">(</span>qfswd_fileChanged_pipe<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> sigaction oldAction<span class="token punctuation">;</span>    <span class="token keyword">struct</span> sigaction action<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    action<span class="token punctuation">.</span>sa_sigaction <span class="token operator">=</span> qfswd_sigio_monitor<span class="token punctuation">;</span>    action<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_SIGINFO<span class="token punctuation">;</span>    <span class="token operator">::</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGIO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oldAction<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldAction<span class="token punctuation">.</span>sa_flags <span class="token operator">&amp;</span> SA_SIGINFO<span class="token punctuation">)</span><span class="token punctuation">)</span>        qfswd_old_sigio_handler <span class="token operator">=</span> oldAction<span class="token punctuation">.</span>sa_handler<span class="token punctuation">;</span>    <span class="token keyword">else</span>        qfswd_old_sigio_action <span class="token operator">=</span> oldAction<span class="token punctuation">.</span>sa_sigaction<span class="token punctuation">;</span><span class="token punctuation">}</span>QDnotifySignalThread<span class="token operator">::</span><span class="token operator">~</span><span class="token function">QDnotifySignalThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        QThread<span class="token operator">::</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">bool</span> QDnotifySignalThread<span class="token operator">::</span><span class="token function">event</span><span class="token punctuation">(</span>QEvent <span class="token operator">*</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token operator">-</span><span class="token operator">></span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QEvent<span class="token operator">::</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>        QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        isExecing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        wait<span class="token punctuation">.</span><span class="token function">wakeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> QThread<span class="token operator">::</span><span class="token function">event</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifySignalThread<span class="token operator">::</span><span class="token function">startNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Note: All this fancy waiting for the thread to enter its event</span>    <span class="token comment" spellcheck="true">// loop is to avoid nasty messages at app shutdown when the</span>    <span class="token comment" spellcheck="true">// QDnotifySignalThread singleton is deleted</span>    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>isExecing<span class="token punctuation">)</span>        wait<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifySignalThread<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QSocketNotifier <span class="token function">sn</span><span class="token punctuation">(</span>qfswd_fileChanged_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> QSocketNotifier<span class="token operator">::</span>Read<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sn<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">activated</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">readFromDnotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QCoreApplication<span class="token operator">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">postEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">QEvent</span><span class="token punctuation">(</span>QEvent<span class="token operator">::</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifySignalThread<span class="token operator">::</span><span class="token function">readFromDnotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> readrv <span class="token operator">=</span> <span class="token function">qt_safe_read</span><span class="token punctuation">(</span>qfswd_fileChanged_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Only expect EAGAIN or EINTR. Other errors are assumed to be impossible.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>readrv <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">Q_ASSERT</span><span class="token punctuation">(</span>readrv <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Q_UNUSED</span><span class="token punctuation">(</span>readrv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span>            <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            emit <span class="token function">fdChanged</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">QDnotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QObject<span class="token operator">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token function">dnotifySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">fdChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                     <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Qt<span class="token operator">::</span>DirectConnection<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token operator">~</span><span class="token function">QDnotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Directory<span class="token operator">></span><span class="token operator">::</span>ConstIterator iter <span class="token operator">=</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">constBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            iter <span class="token operator">!=</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">constEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">++</span>iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">qt_safe_close</span><span class="token punctuation">(</span>iter<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>iter<span class="token operator">-</span><span class="token operator">></span>parentFd<span class="token punctuation">)</span>            <span class="token function">qt_safe_close</span><span class="token punctuation">(</span>iter<span class="token operator">-</span><span class="token operator">></span>parentFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>QDnotifyFileSystemWatcherEngine <span class="token operator">*</span>QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">QDnotifyFileSystemWatcherEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">qFatal</span><span class="token punctuation">(</span><span class="token string">"QDnotifyFileSystemWatcherEngine thread should not be run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>QStringList QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">addPaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList p <span class="token operator">=</span> paths<span class="token punctuation">;</span>    QMutableListIterator<span class="token operator">&lt;</span>QString<span class="token operator">></span> <span class="token function">it</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QString path <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        QFileInfo <span class="token function">fi</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fi<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">bool</span> isDir <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">isDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDir <span class="token operator">&amp;&amp;</span> directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">contains</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Skip monitored directories</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isDir <span class="token operator">&amp;&amp;</span> files<span class="token operator">-</span><span class="token operator">></span><span class="token function">contains</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Skip monitored files</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isDir<span class="token punctuation">)</span>            path <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">canonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Locate the directory entry (creating if needed)</span>        <span class="token keyword">int</span> fd <span class="token operator">=</span> pathToFD<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            QT_DIR <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">QT_OPENDIR</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">toUtf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>d<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Could not open directory</span>            QT_DIR <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            QDir <span class="token function">parentDir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>parentDir<span class="token punctuation">.</span><span class="token function">isRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                parentDir<span class="token punctuation">.</span><span class="token function">cdUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                parent <span class="token operator">=</span> <span class="token function">QT_OPENDIR</span><span class="token punctuation">(</span>parentDir<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUtf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">QT_CLOSEDIR</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            fd <span class="token operator">=</span> <span class="token function">qt_safe_dup</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">dirfd</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> parentFd <span class="token operator">=</span> parent <span class="token operator">?</span> <span class="token function">qt_safe_dup</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">dirfd</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">QT_CLOSEDIR</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token function">QT_CLOSEDIR</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">Q_ASSERT</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETSIG<span class="token punctuation">,</span> SIGIO<span class="token punctuation">)</span> <span class="token operator">||</span>               <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_NOTIFY<span class="token punctuation">,</span> DN_MODIFY <span class="token operator">|</span> DN_CREATE <span class="token operator">|</span> DN_DELETE <span class="token operator">|</span>                                     DN_RENAME <span class="token operator">|</span> DN_ATTRIB <span class="token operator">|</span> DN_MULTISHOT<span class="token punctuation">)</span> <span class="token operator">||</span>               <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>parentFd<span class="token punctuation">,</span> F_SETSIG<span class="token punctuation">,</span> SIGIO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>               <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>parentFd<span class="token punctuation">,</span> F_NOTIFY<span class="token punctuation">,</span> DN_DELETE <span class="token operator">|</span> DN_RENAME <span class="token operator">|</span>                                            DN_MULTISHOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Could not set appropriate flags</span>            <span class="token punctuation">}</span>            Directory dir<span class="token punctuation">;</span>            dir<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>            dir<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>            dir<span class="token punctuation">.</span>parentFd <span class="token operator">=</span> parentFd<span class="token punctuation">;</span>            fdToDirectory<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>            pathToFD<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>parentFd<span class="token punctuation">)</span>                parentToFD<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>parentFd<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Directory <span class="token operator">&amp;</span>directory <span class="token operator">=</span> fdToDirectory<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>            directory<span class="token punctuation">.</span>isMonitored <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            Directory<span class="token operator">::</span>File file<span class="token punctuation">;</span>            file<span class="token punctuation">.</span>path <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">filePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            file<span class="token punctuation">.</span>lastWrite <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>            pathToFD<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">filePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>            directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">append</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            files<span class="token operator">-</span><span class="token operator">></span><span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">filePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">dnotifySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">}</span>QStringList QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">removePaths</span><span class="token punctuation">(</span><span class="token keyword">const</span> QStringList <span class="token operator">&amp;</span>paths<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>files<span class="token punctuation">,</span> QStringList <span class="token operator">*</span>directories<span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    QStringList p <span class="token operator">=</span> paths<span class="token punctuation">;</span>    QMutableListIterator<span class="token operator">&lt;</span>QString<span class="token operator">></span> <span class="token function">it</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QString path <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> fd <span class="token operator">=</span> pathToFD<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fd<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        Directory <span class="token operator">&amp;</span>directory <span class="token operator">=</span> fdToDirectory<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">bool</span> isDir <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>            isDir <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            directory<span class="token punctuation">.</span>isMonitored <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>directory<span class="token punctuation">.</span>isMonitored <span class="token operator">&amp;&amp;</span> directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// No longer needed</span>            <span class="token function">qt_safe_close</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>            pathToFD<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>            fdToDirectory<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>            directories<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeAll</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            files<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeAll</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">{</span>    QMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> wasParent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Directory<span class="token operator">></span><span class="token operator">::</span>Iterator iter <span class="token operator">=</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>iter <span class="token operator">==</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QHash<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span><span class="token operator">::</span>Iterator pIter <span class="token operator">=</span> parentToFD<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pIter <span class="token operator">==</span> parentToFD<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        iter <span class="token operator">=</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token operator">*</span>pIter<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">==</span> fdToDirectory<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        wasParent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Directory <span class="token operator">&amp;</span>directory <span class="token operator">=</span> <span class="token operator">*</span>iter<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>wasParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Directory<span class="token operator">::</span>File <span class="token operator">&amp;</span>file <span class="token operator">=</span> directory<span class="token punctuation">.</span>files<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">updateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Emit signal</span>                QString filePath <span class="token operator">=</span> file<span class="token punctuation">.</span>path<span class="token punctuation">;</span>                <span class="token keyword">bool</span> removed <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">QFileInfo</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">--</span>ii<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                emit <span class="token function">fileChanged</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> removed<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>isMonitored<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Emit signal</span>        <span class="token keyword">bool</span> removed <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">QFileInfo</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        QString path <span class="token operator">=</span> directory<span class="token punctuation">.</span>path<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span>            directory<span class="token punctuation">.</span>isMonitored <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        emit <span class="token function">directoryChanged</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> removed<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>directory<span class="token punctuation">.</span>isMonitored <span class="token operator">&amp;&amp;</span> directory<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">qt_safe_close</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>parentFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">qt_safe_close</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>parentFd<span class="token punctuation">)</span><span class="token punctuation">;</span>            parentToFD<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span>parentFd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        fdToDirectory<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> QDnotifyFileSystemWatcherEngine<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">bool</span> QDnotifyFileSystemWatcherEngine<span class="token operator">::</span>Directory<span class="token operator">::</span>File<span class="token operator">::</span><span class="token function">updateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QFileInfo <span class="token function">fi</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    QDateTime nLastWrite <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint nOwnerId <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">ownerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint nGroupId <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">groupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QFile<span class="token operator">::</span>Permissions nPermissions <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">permissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>nLastWrite <span class="token operator">!=</span> lastWrite <span class="token operator">||</span>       nOwnerId <span class="token operator">!=</span> ownerId <span class="token operator">||</span>       nGroupId <span class="token operator">!=</span> groupId <span class="token operator">||</span>       nPermissions <span class="token operator">!=</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ownerId <span class="token operator">=</span> nOwnerId<span class="token punctuation">;</span>        groupId <span class="token operator">=</span> nGroupId<span class="token punctuation">;</span>        permissions <span class="token operator">=</span> nPermissions<span class="token punctuation">;</span>        lastWrite <span class="token operator">=</span> nLastWrite<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="Dnotify"><a href="#Dnotify" class="headerlink" title="Dnotify"></a>Dnotify</h2><p>Dnotify同理，也是使用的Linux的系统函数 /usr/include/unistd.h  主要是这个头文件中的函数。有一些关于文件描述符相关的函数</p><p>里边主要监控的是其内部类的相关的信息</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token keyword">struct</span> Directory <span class="token punctuation">{</span>        <span class="token function">Directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">parentFd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isMonitored</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token function">Directory</span><span class="token punctuation">(</span><span class="token keyword">const</span> Directory <span class="token operator">&amp;</span>o<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">path</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">fd</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">parentFd</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>parentFd<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">isMonitored</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>isMonitored<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token function">files</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        QString path<span class="token punctuation">;</span>        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>        <span class="token keyword">int</span> parentFd<span class="token punctuation">;</span>        <span class="token keyword">bool</span> isMonitored<span class="token punctuation">;</span>        <span class="token keyword">struct</span> File <span class="token punctuation">{</span>            <span class="token function">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ownerId</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">groupId</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">permissions</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>            <span class="token function">File</span><span class="token punctuation">(</span><span class="token keyword">const</span> File <span class="token operator">&amp;</span>o<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">path</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">ownerId</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>ownerId<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">groupId</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>groupId<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">permissions</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>permissions<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token function">lastWrite</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>lastWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            QString path<span class="token punctuation">;</span>            <span class="token keyword">bool</span> <span class="token function">updateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            uint ownerId<span class="token punctuation">;</span>            uint groupId<span class="token punctuation">;</span>            QFile<span class="token operator">::</span>Permissions permissions<span class="token punctuation">;</span>            QDateTime lastWrite<span class="token punctuation">;</span></code></pre><p>可以直接看这个结构D需要这四个描述信息</p><pre class=" language-cpp"><code class="language-cpp">        QString path<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//路径</span>        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//文件的描述符</span>        <span class="token keyword">int</span> parentFd<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//父亲的描述符号</span>        <span class="token keyword">bool</span> isMonitored<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//是否正在监控</span></code></pre><p>其中这四个信息都是通过<em>Linux的库函数</em>与结构体来获取的。 其中遍历文件夹则是使用Qt的QFileInfo来遍历添加paths的信息，存储到其类的成员变量中。</p><pre><code>// Directory iteration#define QT_DIR DIR#define QT_OPENDIR ::opendir#define QT_CLOSEDIR ::closedir</code></pre><p>Dir下的file需要这些信息</p><pre class=" language-cpp"><code class="language-cpp">            QString path<span class="token punctuation">;</span>            uint ownerId<span class="token punctuation">;</span>            uint groupId<span class="token punctuation">;</span>            QFile<span class="token operator">::</span>Permissions permissions<span class="token punctuation">;</span>            QDateTime lastWrite<span class="token punctuation">;</span></code></pre><p>现在说一下关键代码</p><pre class=" language-cpp"><code class="language-cpp">    ret <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// set non-block too?</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span> <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> <span class="token operator">::</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span> <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>其中 pipefd[0]表示读，pipefd[1]表示写，实际上<br>关键代码在这里。</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span> QDnotifySignalThread<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QSocketNotifier <span class="token function">sn</span><span class="token punctuation">(</span>qfswd_fileChanged_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> QSocketNotifier<span class="token operator">::</span>Read<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sn<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">activated</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">readFromDnotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QCoreApplication<span class="token operator">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">postEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">QEvent</span><span class="token punctuation">(</span>QEvent<span class="token operator">::</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这段代码实际上是使用QSocketNotifier实时检测出从pip管道中读取有关于文件信息的变化，加到了Qt在Linux下的事件循环中（还记上以前有个老哥写的那个u盘检测工具么？实际上原理跟这个一样，都是通过socket来读取文件描述符的状态来检测其变化）。然后等待其消息通知变化。这样来实时监控文件夹与文件的变化。其中QDnotify大量使用了Unix的库函数，建议有兴趣的可以多读读Unix高级环境编程这本书，可以当个字典来看。我也不一个个解释了。实际上这个类，我读起来也是有点吃力，因为大部分都是Linux的库函数，还是得补补课去看看《Unix环境高级编程》了</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这两个类的主要原理是先缓存当前addpath的文件or文件夹的信息，然后再通过socket来实时检测其变化。获取当前的信息与缓存的信息做对比，如果有变化，就发送对应的信号。这样我们就可以检测到文件or文件夹的变化了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Qt源码 </tag>
            
            <tag> Qt源码剖析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qt源码之魔改QFileDialog之路-2 移动介质的处理</title>
      <link href="/2020/06/26/qt-yuan-ma-zhi-mo-gai-qfiledialog-zhi-lu-2-yi-dong-jie-zhi-de-chu-li/"/>
      <url>/2020/06/26/qt-yuan-ma-zhi-mo-gai-qfiledialog-zhi-lu-2-yi-dong-jie-zhi-de-chu-li/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>移动介质，一般就是指当前Linux系统下的 <strong>U 盘 / 挂载硬盘</strong>。 这两个移动介质都是挂载在<strong>/media/yourusername</strong>下来做的处理。（fhs2.4）（实际上fhs3.0的标准已经改到/run/media/username下了）</p><h2 id="前期调研"><a href="#前期调研" class="headerlink" title="前期调研"></a>前期调研</h2><p>从网上找到关于u盘检测的插拔有两种方案（这两种方案硬盘挂载是检测不到的）：</p><h3 id="U盘插拔检测"><a href="#U盘插拔检测" class="headerlink" title="U盘插拔检测"></a>U盘插拔检测</h3><h4 id="QDbus的方案"><a href="#QDbus的方案" class="headerlink" title="QDbus的方案"></a>QDbus的方案</h4><blockquote><ul><li>使用QDbus来检测U盘的插拔的处理，原文链接 <a href="http://www.qtcn.org/bbs/read-htm-tid-14535.html" target="_blank" rel="noopener">http://www.qtcn.org/bbs/read-htm-tid-14535.html</a></li></ul></blockquote><p>防止网址被吞这里把代码上上</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//在pro文件中应该加入</span>QT <span class="token operator">+</span><span class="token operator">=</span>dbus<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QtDBus/QDBusConnection></span></span><span class="token comment" spellcheck="true">//以下为检测设备的插入</span>QDBusConnection<span class="token operator">::</span><span class="token function">systemBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token string">"org.freedesktop.Hal"</span><span class="token punctuation">,</span>                        <span class="token string">"/org/freedesktop/Hal/Manager"</span><span class="token punctuation">,</span>                        <span class="token string">"org.freedesktop.Hal.Manager"</span><span class="token punctuation">,</span>                        <span class="token string">"DeviceAdded"</span><span class="token punctuation">,</span>                        <span class="token keyword">this</span><span class="token punctuation">,</span>                        <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">slotDeviceAdded</span><span class="token punctuation">(</span>QString <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//以下为检查设备的拨出</span>QDBusConnection<span class="token operator">::</span><span class="token function">systemBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token string">"org.freedesktop.Hal"</span><span class="token punctuation">,</span>                        <span class="token string">"/org/freedesktop/Hal/Manager"</span><span class="token punctuation">,</span>                        <span class="token string">"org.freedesktop.Hal.Manager"</span><span class="token punctuation">,</span>                        <span class="token string">"DeviceRemoved"</span><span class="token punctuation">,</span>                        <span class="token keyword">this</span><span class="token punctuation">,</span>                        <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">slotDeviceRemoved</span><span class="token punctuation">(</span>QString <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//在slotDeviceAdded(QString udi)函数中，要使用到</span>QDBusInterface <span class="token function">device</span><span class="token punctuation">(</span><span class="token string">"org.freedesktop.Hal"</span><span class="token punctuation">,</span> udi<span class="token punctuation">,</span> <span class="token string">"org.freedesktop.Hal.Device"</span> <span class="token punctuation">,</span> QDBusConnection<span class="token operator">::</span><span class="token function">systemBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//通过HAL可以查询到设备为volume的设备，然后通过判断是否为/dev/sd*的设备，就可以判断出是否为U盘，然后调用mount就可以了。</span><span class="token comment" spellcheck="true">//这时记录下U盘的UDI，在检测到设备拨出时，再查询一下U盘的UDI是否还在，就知道U盘是否被拨出了。</span></code></pre><h4 id="QSocketNotifier来实现"><a href="#QSocketNotifier来实现" class="headerlink" title="QSocketNotifier来实现"></a>QSocketNotifier来实现</h4><p>这个是某个老哥使用socket来实现文件监控的，实际上这个方案完全可以使用QFileSystemWatcher来检测<strong>/proc/mounts</strong>（实际上Qt源码QSystemWatcher，里边的监控文件的实现就是使用的QSocketNotifier=。=，既然这个老哥自己想出来了，还是把他的链接贴上去吧，<a href="https://blog.csdn.net/penghuilater/article/details/53410646" target="_blank" rel="noopener">https://blog.csdn.net/penghuilater/article/details/53410646</a> 接下来我会讲QFileSystemWatcher的实现原理的），代码我还是照样贴上，防止网页被吞。</p><pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> VOLUMEMONITOR_H</span><span class="token macro property">#<span class="token directive keyword">define</span> VOLUMEMONITOR_H</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QObject></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QSet></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QSocketNotifier></span></span><span class="token keyword">class</span> <span class="token class-name">VolumeMonitor</span> <span class="token operator">:</span> <span class="token keyword">public</span> QObject<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">VolumeMonitor</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">VolumeMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>signals<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">deviceAdded</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString<span class="token operator">&amp;</span> addDev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">deviceRemoved</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString<span class="token operator">&amp;</span> removeDe<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> slots<span class="token operator">:</span>    <span class="token keyword">bool</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">onFileChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> m_fileKde <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    QSocketNotifier<span class="token operator">*</span> m_socketNotifier<span class="token punctuation">;</span>    QSet<span class="token operator">&lt;</span>QString<span class="token operator">></span> m_fileContentSet<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">// VOLUMEMONITOR_H </span><span class="token comment" spellcheck="true">//-------------------------------------------------------</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"volumemonitor.h"</span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QFile></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QSet></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QTextStream></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QDebug></span></span><span class="token keyword">namespace</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> mountFile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/proc/mounts"</span><span class="token punctuation">;</span>    QSet <span class="token operator">&lt;</span>QString<span class="token operator">></span> <span class="token function">getMountFileContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        QFile <span class="token function">file</span><span class="token punctuation">(</span>mountFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        QSet <span class="token operator">&lt;</span>QString<span class="token operator">></span> fileContentSet<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>QIODevice<span class="token operator">::</span>ReadOnly <span class="token operator">|</span> QIODevice<span class="token operator">::</span>Text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                QTextStream <span class="token function">textStream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>                QString fileContent <span class="token operator">=</span> textStream<span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                QStringList items <span class="token operator">=</span> fileContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">foreach</span> <span class="token punctuation">(</span>QString item<span class="token punctuation">,</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        fileContentSet <span class="token operator">&lt;&lt;</span> item<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> fileContentSet<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    QString <span class="token function">getMountPoint</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString<span class="token operator">&amp;</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> QStringList items <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> items<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>VolumeMonitor<span class="token operator">::</span><span class="token function">VolumeMonitor</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent<span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">QObject</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">bool</span> VolumeMonitor<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//get the set of mounted device's info;</span>    m_fileContentSet <span class="token operator">=</span> <span class="token function">getMountFileContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_fileKde <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>mountFile<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fileKde <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">qWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"open /proc/mounts failed!"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    m_socketNotifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSocketNotifier</span><span class="token punctuation">(</span>m_fileKde<span class="token punctuation">,</span>                                           QSocketNotifier<span class="token operator">::</span>Write<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>m_socketNotifier<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QSocketNotifier<span class="token operator">::</span>activated<span class="token punctuation">,</span>            <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VolumeMonitor<span class="token operator">::</span>onFileChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">bool</span> VolumeMonitor<span class="token operator">::</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fileKde<span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> m_socketNotifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">bool</span> VolumeMonitor<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">close</span><span class="token punctuation">(</span>m_fileKde<span class="token punctuation">)</span><span class="token punctuation">;</span>        m_fileKde <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_socketNotifier<span class="token punctuation">;</span>        m_socketNotifier <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> VolumeMonitor<span class="token operator">::</span><span class="token function">onFileChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    QSet <span class="token operator">&lt;</span>QString<span class="token operator">></span> changedItemSet <span class="token operator">=</span> <span class="token function">getMountFileContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString<span class="token operator">&amp;</span> item<span class="token operator">:</span> changedItemSet <span class="token operator">-</span> m_fileContentSet<span class="token punctuation">)</span>        emit <span class="token function">deviceAdded</span><span class="token punctuation">(</span><span class="token function">getMountPoint</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString<span class="token operator">&amp;</span> item<span class="token operator">:</span> m_fileContentSet <span class="token operator">-</span> changedItemSet<span class="token punctuation">)</span>        emit <span class="token function">deviceRemoved</span><span class="token punctuation">(</span><span class="token function">getMountPoint</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_fileContentSet <span class="token operator">=</span> changedItemSet<span class="token punctuation">;</span><span class="token punctuation">}</span>VolumeMonitor<span class="token operator">::</span><span class="token operator">~</span><span class="token function">VolumeMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="QStorageInfo"><a href="#QStorageInfo" class="headerlink" title="QStorageInfo"></a>QStorageInfo</h4><p>实际上Qt 5.4之后在QtCore中引入了一个新的类叫做QStorageInfo，这个类可以获取到相关的磁盘信息。这个并不是关键的，因为本次我也没有使用这个类，就是在这里简单的提一下。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>实际上这一篇的关键技术是QFileSystemWatcher，把<strong>/media/yourusername</strong>添加到监视目录中，然后就可以通过QFileInfo and QDir来获取到相关的信息，其中QFileDialog中的QFileSystemModel也可以跟随实时更新。这样依旧可以依旧获取到移动介质的信息以及插拔信息。这个才是最终的解决方案。接下来要讲一下QFileSystemWatcher的源码。可能你看到的源码版本与我的版本不同。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Qt源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qt源码之魔改QFileDialog之路-1</title>
      <link href="/2020/06/26/qt-yuan-ma-zhi-mo-gai-qfiledialog-zhi-lu-1/"/>
      <url>/2020/06/26/qt-yuan-ma-zhi-mo-gai-qfiledialog-zhi-lu-1/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前着急发Linux社区版本的WPS，所以这里都没有好好的去更改打开本地文件对话框那里的逻辑。由于这里的代码是从其它平台迁移过来的，所以这里的逻辑就没有动。对于用户交互来讲可以说是非常恶心心了。因为我们是做产品的，产品驱动技术。这次呢，前前后后大概花了两周的时间终于把这个产品稳定下来了。里边碰到了一些技术要点与难点。这里简单的总结下。</p><p>图1. 原来没有</p><h2 id="自己造轮子"><a href="#自己造轮子" class="headerlink" title="自己造轮子"></a>自己造轮子</h2><p>实际上这是我的第一个方案，一开始想得太简单，用了个递归的方式去读取QFileInfo的信息，发现栈爆了，然后用QFileSystQFileemModel来读取当前文件夹的信息。总结下就是使用QFileSystQFileemModel +QFileSystemWatcher +  QAbstractItemDelegate的方式去做，做了一个星期，完成了七八成，但是发现细节真的太多了，再给我两个星期我可能都做不完，于是放弃这个方案。突然想起来Qt还有个自带的QFileDialog。于是才开始我的第二个方案。</p><h2 id="使用QFileDialog类"><a href="#使用QFileDialog类" class="headerlink" title="使用QFileDialog类"></a>使用QFileDialog类</h2><p>这个方案我一开始连想都没有想，只是想尝试下看看能不能改造下，发现最终经过了一个星期的改造+适配也是把这个功能完成了。然后加到WPS中了。下边开始讲我在开发中遇到的一些技术要点。</p><h3 id="QFileDialog简单介绍"><a href="#QFileDialog简单介绍" class="headerlink" title="QFileDialog简单介绍"></a>QFileDialog简单介绍</h3><p>QFileDialog实现基本上是我自己实现的复杂版本，基本要点也是QFileSystemModel类来显示当前的目录信息，使用QFileInfoGatherer 线程类专门监视目录的变化。QFileInfoGatherer线程类基本实现核心也是QFileSystemWatcher，使用了 条件变量 + 锁来做同步。具体的实现还是相当多的， 大家有兴趣可以去阅读下Qt的源码。</p><h3 id="如何改造QFileDialog类"><a href="#如何改造QFileDialog类" class="headerlink" title="如何改造QFileDialog类"></a>如何改造QFileDialog类</h3><h4 id="改造利器"><a href="#改造利器" class="headerlink" title="改造利器"></a>改造利器</h4><p>与其说是如何改造QFileDialog类，不如说是如何改造Qt官方提供的控件，这种方式有一个缺点，就是严重依赖Qt官方源码（ps，有兴趣的可以把这个类的代码提取出来，我去fork，逃））。像WPS自己维护的Qt分支，这个方式我是可以接受的，因为源码就在我这里，哈哈。跑偏了，基本上这样改造是没有多大问题的，官方现在对于QWidget这套代码改动实际上是很少的。现在说一下改造QFileDialog的利器</p><ul><li>findChild()</li><li>findChildren()</li><li>metaObject()-&gt;className() (实际上这个基本没用到，了解下也是很好的)</li></ul><h4 id="改造原理"><a href="#改造原理" class="headerlink" title="改造原理"></a>改造原理</h4><p>todo findchild与findchildren的文章。<br>findChild&lt;QLineEdit*&gt;(“fileNameEdit”);</p><ul><li>设置QFileDialog的setOption</li><li>使用fildChild通过控件名 或者通过findChildren 找到 需要隐藏的左边列表，然后setVisible(false);</li></ul><p>这样最关键的问题解决了，可以把这个东西设置成无边框然后嵌入到右边的控件中。然后在对话框中左边加上几个侧边栏，然后主要问题就解决了。</p><h4 id="改造细节，其它的相关细节，比如过滤器相关的属性设置QFileDialog都有相关的接口去设置（这个自己去阅读API文档去），唯一一个需要我去解决的就是保存时要将后缀名取出来，然后用到了QtFileDialog中的正则表达式，我已经提取出来了。"><a href="#改造细节，其它的相关细节，比如过滤器相关的属性设置QFileDialog都有相关的接口去设置（这个自己去阅读API文档去），唯一一个需要我去解决的就是保存时要将后缀名取出来，然后用到了QtFileDialog中的正则表达式，我已经提取出来了。" class="headerlink" title="改造细节，其它的相关细节，比如过滤器相关的属性设置QFileDialog都有相关的接口去设置（这个自己去阅读API文档去），唯一一个需要我去解决的就是保存时要将后缀名取出来，然后用到了QtFileDialog中的正则表达式，我已经提取出来了。"></a>改造细节，其它的相关细节，比如过滤器相关的属性设置QFileDialog都有相关的接口去设置（这个自己去阅读API文档去），唯一一个需要我去解决的就是保存时要将后缀名取出来，然后用到了QtFileDialog中的正则表达式，我已经提取出来了。</h4><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>以为这就完了？图样图内务。还有移动介质呢？！</p><h1 id="NOW"><a href="#NOW" class="headerlink" title="NOW"></a>NOW</h1><p>这是我18年的解决方案了。现在准备自己重写这个东西，感觉也没有什么难得地方。这里准备重写了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Qt源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>error: &#39;this&#39; cannot be implicitly captured in this context</title>
      <link href="/2020/06/26/error-this-cannot-be-implicitly-captured-in-this-context/"/>
      <url>/2020/06/26/error-this-cannot-be-implicitly-captured-in-this-context/</url>
      
        <content type="html"><![CDATA[<p>讲真，使用Qt反射 + 元对象 + C++11 的特性，写c++代码简直不要太爽，代码优雅的不是一丁半点。</p><p>今天使用lambda表达式的时候，发现报了个编译错误</p><pre class=" language-cpp"><code class="language-cpp">error<span class="token operator">:</span> <span class="token string">'this'</span> cannot be implicitly captured in <span class="token keyword">this</span> context</code></pre><p>纠其原因，在于我在lambda表达式中使用了某个成员变量，但是没有捕获this</p><p>把代码</p><pre class=" language-cpp"><code class="language-cpp"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>加上this就可以了</p><pre class=" language-cpp"><code class="language-cpp"><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> cpp </tag>
            
            <tag> lambda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>QFileDialog中的tips</title>
      <link href="/2020/06/26/qfiledialog-zhong-de-tips/"/>
      <url>/2020/06/26/qfiledialog-zhong-de-tips/</url>
      
        <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>最近看QFileDialog的实现比较多，也对比了几家操作系统厂商跟Qt的QFileDialog中的实现，也自己造了个小轮子。也学到了一些东西，特意来分享下。</p><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>可以将类型诸如这种的格式</p><pre><code>WPS文字 文件(*.wps)  提取成这种 *.wps</code></pre><p>本来打算自己写正则表达式的，生怕自己写的效率比较低，就从QFileDialog的源码中扣取出来了。</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//from QFileDialog</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>qt_file_dialog_filter_reg_exp <span class="token operator">=</span><span class="token string">"^(.*)\\(([a-zA-Z0-9_.*? +;#\\-\\[\\]@\\{\\}/!&lt;>\\$%&amp;=^~:\\|]*)\\)$"</span><span class="token punctuation">;</span>QStringList <span class="token function">qt_clean_filter_list</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span>filter<span class="token punctuation">)</span><span class="token punctuation">{</span>    QRegExp <span class="token function">regexp</span><span class="token punctuation">(</span>QString<span class="token operator">::</span><span class="token function">fromLatin1</span><span class="token punctuation">(</span>qt_file_dialog_filter_reg_exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QString f <span class="token operator">=</span> filter<span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">indexIn</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>        f <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">cap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token function">QLatin1Char</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> QString<span class="token operator">::</span>SkipEmptyParts<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="QFileInfo的新奇使用方法"><a href="#QFileInfo的新奇使用方法" class="headerlink" title="QFileInfo的新奇使用方法"></a>QFileInfo的新奇使用方法</h3><p>实际上我又遇到了一个源码中关于QFileInfo一个原来没有用过的用法。</p><p>直接将</p><pre class=" language-cpp"><code class="language-cpp"><span class="token operator">*</span><span class="token punctuation">.</span>wps </code></pre><p>这种字符当做QString放进了QFileInfo来获取其basename（文件名）跟 suffix（后缀），或者使用其它的函数。一般我都是传个文件路径的，没想到还能用这种方法解析字符串。</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//这时候可以用QFileInfo把一些复杂的字符串的什么前缀，后缀名全都解析出来了，包括*.tar.gz这种复杂的，QFileInfo都有函数来提取</span>QFileInfo <span class="token function">fileInfo</span><span class="token punctuation">(</span><span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"*.wps"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我本来想自己解析这个字符串的，发现QFileDialog的源码中还有这种用法，真的很神奇。</p><h3 id="文件管理器的吐槽"><a href="#文件管理器的吐槽" class="headerlink" title="文件管理器的吐槽"></a>文件管理器的吐槽</h3><p>最近看了看KDE的dolphin文件管理器代码的实现，还有深度的文件管理器的实现，还有一些乱七八糟第三方的，还有Qt自带的QFileDialog。就属KDE的dolphin做的最厉害，交互最好，优化的最好。</p><p>深度的文件管理器跟Qt自带QFileDialog遇到复杂的网络文件以及延迟都会卡死，也没有任何交互。QFileDialog我理解这个东西一开始就不是给网络文件用的，卡死我还是可以接受的，但是深度作为操作系统厂商做成这样就有点不太合适了。大概扫了下源码，也跟QFileDialog一样重写了model，model这里交互还是得好好优化下啊。这就是自己造轮子的坏处。</p><p>从一个开发的角度，简单的吐槽一下，反正给他们官方反馈了。因为deepin的文件管理器的bug实在太多了=。=。</p><p>嗯，KDE大法好！话说，一开始的设计可以从借鉴（copy）KDE的实现嘛，都这么多年了…</p><p>造轮子不要对自己太自信…实时上我自己造的小轮子也有这个问题=。=。</p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>这是我前年的时候看各个厂商以及调研QFileDialog总结出来一点小结论。去年年底我又把这部分捡起来了。现在已经优化到加载千万级别的数据，界面不会卡住的地步了。有时间把这部分东西写出来</p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Qt源码 </tag>
            
            <tag> QFileDialog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux更换difftool为meld</title>
      <link href="/2020/06/26/linux-geng-huan-difftool-wei-meld/"/>
      <url>/2020/06/26/linux-geng-huan-difftool-wei-meld/</url>
      
        <content type="html"><![CDATA[<h3 id="meld"><a href="#meld" class="headerlink" title="meld"></a>meld</h3><pre class=" language-shell"><code class="language-shell">#设置默认的git diff的比较工具#配置比较工具.可以用git difftool 调用.git config --global diff.tool meldgit config --global difftool.prompt false</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> git </tag>
            
            <tag> meld </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用QtCteator编译QtCreator</title>
      <link href="/2020/06/26/shi-yong-qtcteator-bian-yi-qtcreator/"/>
      <url>/2020/06/26/shi-yong-qtcteator-bian-yi-qtcreator/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>原谅我标题党了，本文标题应该是使用Clang依赖Qt编译QtCreator。</p><p>目前在Linux上做开发，一直使用的IDE就是QtCreator。 实际上一直有想做一个编辑器的想法（因为我觉得QtCreator有点笨重，而我只是想要一个单纯的编辑器的功能。目前开源的优秀的使用Qt制作的编辑器好象是没有。我也一直喜欢使用vim，而且QtCreator也有fakevim的插件。QtCreator我也用着比较舒服，还是Qt写的，我也比较熟悉Qt的代码，所以想要魔改这个项目了。而且从官方fork的话，以后有啥bug可以直接cherry-pick过来，逃）。趁着这个机会，阅读下这个IDE的架构是如何设计的。</p><p>我个人一直很喜欢QtCreator这个IDE，当然没有vs强大（宇宙第一IDE可不是吹的），是不可多得的优秀的IDE。配置环境什么的也比较简单方便。目前我的开发机器环境为Ubuntu16.04,就暂时以这个环境来讲吧。</p><h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><p>如果编译QtCreator，实际上官方的wiki是有的，链接在这里 <a href="https://wiki.qt.io/Building_Qt_Creator_from_Git" target="_blank" rel="noopener">https://wiki.qt.io/Building_Qt_Creator_from_Git</a> 简单的讲，就是如下几个条件</p><blockquote><ul><li>Qt5.6.2及以后版本以后版本的Qt库</li><li>clang5.0及之后版本的编译器</li></ul></blockquote><h3 id="Qt编译"><a href="#Qt编译" class="headerlink" title="Qt编译"></a>Qt编译</h3><p>截止2018年10月13日。目前最新的Qt版本是Qt5.11.2。（5.12还在测试中）那就以最新的Qt版本来编译QtCreator吧。去官网下载最新版本的Qt源码<a href="http://download.qt.io/archive/qt/5.11/5.11.2/single/" target="_blank" rel="noopener">http://download.qt.io/archive/qt/5.11/5.11.2/single/</a><br>比如我就下载到了 /home/zhangpf/Qt/Qt5.11下，解压到当前文件夹，然后新建个新的目录用于放编译好的Qt。</p><pre class=" language-shell"><code class="language-shell">mkdir qt5.11.2cd /home/zhangpf/Qt/Qt5.11/qt-everywhere-src-5.11.2</code></pre><p>准备编译Qt。（在这里我一开始下载的Qt5.10的版本，因为我还怕5.11不稳定，但是发现编译的时候QtScript模块编译不过，QtCreator工程又依赖QtScript，google了下发现不只是我有这个问题，但是还未解决，已经报了QTBUG。所以我才又下载的Qt5.11的版本来编译的。）</p><p>然后继续</p><pre class=" language-shell"><code class="language-shell">./configure -prefix /home/zhangpf/Qt/Qt5.11/qt5.11.2 -debug -opensource -confirm-licensecd /home/zhangpf/Qt/Qt5.11/qt5.11.2make && make install</code></pre><p>比如我的电脑cpu是i7-7700,4核8线程，我就可以make -j8。还是看自己电脑的性能了。<br>恩，这时候Qt5.11.2的库就准备好了。</p><h2 id="clang准备。"><a href="#clang准备。" class="headerlink" title="clang准备。"></a>clang准备。</h2><p>下载链接<a href="http://releases.llvm.org/download.html" target="_blank" rel="noopener">http://releases.llvm.org/download.html</a> 下载clang clang++ 5.0以后预编译好的版本，比如我就是下载clang6.0的Ubuntu16.04的版本。下载下来可以直接用。放到了/opt 下，然后我又做了个软链到/usr/local/bin/下。</p><h2 id="QtCreator准备"><a href="#QtCreator准备" class="headerlink" title="QtCreator准备"></a>QtCreator准备</h2><p>官方已经讲得很明确了，直接</p><pre><code>git clone --recursive https://code.qt.io/qt-creator/qt-creator.git</code></pre><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><h3 id="配置QtCreator"><a href="#配置QtCreator" class="headerlink" title="配置QtCreator"></a>配置QtCreator</h3><blockquote><ul><li>工具-选项-构建和运行-编译器   把刚才下载好的clang添加进去，点击应用</li><li>工具-选项-构建和运行-QtVersion 添加一个QtVersion 把编译好的Qt5.11.2 qmake路径加进去，点击应用</li><li>工具-选项-构建和运行-构建套件 添加一个构建套件取名qtcreator，编译器跟QtVersion选择成刚才添加的。点击应用</li></ul></blockquote><h3 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h3><p>直接打开QtCreator的pro文件，构建套件选择刚才新建的qtcreator。然后直接右键pro文件，qmake-&gt;构建.</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>qtcreator源码149m。编译出来的debug版本的QtCreator 1.5G。也是相当大的一个Qt工程了。从头折腾到尾，基本没发现啥大的编译问题与疑难杂症，也就只有一个Qt5.10版本QtScript编译不过的问题，还被我规避掉了。接下来就该阅读这个工程的源码，去更改我想要的结果了。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu16.04下pip3的安装，升级，卸载</title>
      <link href="/2020/06/26/ubuntu16-04-xia-pip3-de-an-zhuang-sheng-ji-xie-zai/"/>
      <url>/2020/06/26/ubuntu16-04-xia-pip3-de-an-zhuang-sheng-ji-xie-zai/</url>
      
        <content type="html"><![CDATA[<p>最近开发机换了Ubuntu16.04，来记录下。</p><p>Python2与Python3是可以共存的，Ubuntu默认装好了。<br>命令python就是Python2<br>命令python3一般是Python3.5</p><p>以下命令适用于Python2，把pip3改成对应的pip就好</p><p>安装pip3</p><pre class=" language-shell"><code class="language-shell">sudo apt-get install python3-pip</code></pre><p>升级pip3</p><pre class=" language-shell"><code class="language-shell">sudo pip3 install --upgrade pip</code></pre><p>卸载pip3</p><pre class=" language-shell"><code class="language-shell">sudo apt-get remove python3-pip</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Python </tag>
            
            <tag> pip3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Poppler在Windows下编译</title>
      <link href="/2020/06/26/poppler-zai-windows-xia-bian-yi/"/>
      <url>/2020/06/26/poppler-zai-windows-xia-bian-yi/</url>
      
        <content type="html"><![CDATA[<h2 id="windows库（已经编译好了。）"><a href="#windows库（已经编译好了。）" class="headerlink" title="windows库（已经编译好了。）"></a>windows库（已经编译好了。）</h2><p>Poppler在Windows下编译还是相当麻烦的，实际上很多库在windows下编译都会有问题。但是有老哥在Windows下使用GCC编译好了一个库，这里是下载链接，这个也是我在Windows上一直使用的一个库。<br><a href="https://sourceforge.net/projects/poppler-win32/" target="_blank" rel="noopener">https://sourceforge.net/projects/poppler-win32/</a></p><h2 id="Poppler-data"><a href="#Poppler-data" class="headerlink" title="Poppler-data"></a>Poppler-data</h2><p>有个老哥在github上给我提出了个issue，发现我的阅读器打开京东的pdf的发票有的字体显示不全，（他要基于我的代码做个打印发票的系统，改就改吧=，=）。他把官网的<a href="https://poppler.freedesktop.org/" target="_blank" rel="noopener">https://poppler.freedesktop.org/</a> 里边有个poppler-data编译好了，给我提了个push。然后也没有说明怎么编译。这就比较蛋疼了。经过验证发现确实是这个问题，然后我总结了下编译过程。</p><p>使用QtCreater自带的MinGW（里边的GCC）编译</p><p>下载官网界面下的poppler-data链接，进入目录，安装到E盘，然后把安装好的目录直接拷贝到阅读器中的3rdparty下，就显示正常了。</p><pre><code>cmake . -DCMAKE_INSTALL_PREFIX=E:mingw32-makemingw32-make install</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> poppler </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Poppler在Mac OS下编译</title>
      <link href="/2020/06/26/poppler-zai-mac-os-xia-bian-yi/"/>
      <url>/2020/06/26/poppler-zai-mac-os-xia-bian-yi/</url>
      
        <content type="html"><![CDATA[<p>#前言<br>众所周知，Poppler-qt5是跨平台的，但是目前Poppler在Mac OS下编译的资料一直没有找到。但是目前手头也没有mac的机器来试试（我可是搞Linux的！但是都是一个Unix爹啊）。目前有两个方法去编译Mac版本的poppler。现在特意总结下。毕竟我还是想把自己的阅读器搞到Mac上试试的。（这就是你想买Mac的理由？）</p><h2 id="MacPorts"><a href="#MacPorts" class="headerlink" title="MacPorts"></a>MacPorts</h2><p>去Poppler的官方网站发现Poppler是支持MacPorts的。MacPorts是Mac上支持的第三方的包管理器（跟Ubuntu的 apt-get很像）。可以通过这个包管理器安装。</p><h2 id="自己编译"><a href="#自己编译" class="headerlink" title="自己编译"></a>自己编译</h2><p>浏览了半天，发现一个老外写的文章。特意把链接放到这里。有兴趣的可以自己编译下。<br>原文<a href="http://www.freebyte.fr/?p=8" target="_blank" rel="noopener">http://www.freebyte.fr/?p=8</a></p><p>这是我目前找到的所有在MacOS下编译的方法了。有想过使用google跟福昕合作开源的pdfium，先给自己挖个坑吧。</p><p>PS:<br>最新的Qt6预览版已经有了pdf模块，就是使用的webengine里的pdf模块。<br>等出来之后就可以更新自己的阅读器了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> poppler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qt在Linux下获取当前系统用户名</title>
      <link href="/2020/06/26/qt-zai-linux-xia-huo-qu-dang-qian-xi-tong-yong-hu-ming/"/>
      <url>/2020/06/26/qt-zai-linux-xia-huo-qu-dang-qian-xi-tong-yong-hu-ming/</url>
      
        <content type="html"><![CDATA[<p> Qt没有直接的接口去获取到当前系统用户名，只能够间接的通过现有的接口去获取。（比如下边的例子通过获取home路径）</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//Qt4 version</span>QString <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      QString userName <span class="token operator">=</span> QDesktopServices<span class="token operator">::</span><span class="token function">storageLocation</span><span class="token punctuation">(</span>QDesktopServices<span class="token operator">::</span>HomeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>    userName <span class="token operator">=</span> userName<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> userName<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//Qt5 version</span>QString <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    QString userPath <span class="token operator">=</span> QStandardPaths<span class="token operator">::</span><span class="token function">writableLocation</span><span class="token punctuation">(</span>QStandardPaths<span class="token operator">::</span>HomeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>     QString userName <span class="token operator">=</span> userPath<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> userName<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>poppler-data(Windows)编译</title>
      <link href="/2020/06/26/poppler-data-windows-bian-yi/"/>
      <url>/2020/06/26/poppler-data-windows-bian-yi/</url>
      
        <content type="html"><![CDATA[<p>以Windows平台举例</p><p>下载 poppler-data ，进入目录</p><p>下载链接</p><p><a href="https://poppler.freedesktop.org/" target="_blank" rel="noopener">https://poppler.freedesktop.org/</a></p><pre><code>cmake . -DCMAKE_INSTALL_PREFIX=E:mingw32-makemingw32-make install</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> poppler </tag>
            
            <tag> poppler-data </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qt线程基础</title>
      <link href="/2020/06/14/qt-xian-cheng-ji-chu/"/>
      <url>/2020/06/14/qt-xian-cheng-ji-chu/</url>
      
        <content type="html"><![CDATA[<h1 id="线程的概念"><a href="#线程的概念" class="headerlink" title="线程的概念"></a>线程的概念</h1><h2 id="WIKI："><a href="#WIKI：" class="headerlink" title="WIKI："></a>WIKI：</h2><blockquote><p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在Unix System V及SunOS中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。<br>线程是独立调度和分派的基本单位。线程可以为操作系统内核调度的内核线程，如Win32线程；由用户进程自行调度的用户线程，如Linux平台的POSIX Thread；或者由内核与用户进程，如Windows 7的线程，进行混合调度。<br>同一进程中的多条线程将共享该进程中的全部系统资源，如虚拟地址空间，文件描述符和信号处理等等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。<br>一个进程可以有很多线程，每条线程并行执行不同的任务。<br>在多核或多CPU，或支持Hyper-threading的CPU上使用多线程程序设计的好处是显而易见，即提高了程序的执行吞吐率。在单CPU单核的计算机上，使用多线程技术，也可以把进程中负责I/O处理、人机交互而常被阻塞的部分与密集计算的部分分开来执行，编写专门的workhorse线程执行密集计算，从而提高了程序的执行效率。</p></blockquote><h1 id="Qt中的线程"><a href="#Qt中的线程" class="headerlink" title="Qt中的线程"></a>Qt中的线程</h1><p>Qt中的线程类是QThread。</p><p>一个QThread对象管理程序中的一个控制线程。QThreads开始在run()中执行。默认情况下，run()通过调用exec()启动事件循环，并在线程内部运行Qt事件循环。</p><p>跟C++标准库中的thread不一样，Qt中的QThread是默认自带一个事件循环的。也就是你可以通过信号槽来进行线程之间的通信（这样就不需要写各种回调函数了）。这大大的简便了线程通信的复杂逻辑。</p><h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><p>先上一个简单的例子，点击按钮，开启一个新的线程，线程中输出从1-1000,结束之后发送信号workfinished</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">WorkerThread</span> <span class="token operator">:</span> <span class="token keyword">public</span> QThread<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">WorkerThread</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token operator">:</span> <span class="token function">QThread</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token keyword">protected</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        emit <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>signals<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>MainWindow<span class="token operator">::</span><span class="token function">MainWindow</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">QMainWindow</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>    <span class="token punctuation">,</span> <span class="token function">ui</span><span class="token punctuation">(</span><span class="token keyword">new</span> Ui<span class="token operator">::</span>MainWindow<span class="token punctuation">)</span><span class="token punctuation">{</span>    ui<span class="token operator">-</span><span class="token operator">></span><span class="token function">setupUi</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    WorkerThread<span class="token operator">*</span> workThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">WorkerThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token operator">-</span><span class="token operator">></span>pushButton<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QPushButton<span class="token operator">::</span>clicked<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        workThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>workThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WorkerThread<span class="token operator">::</span>workFinished<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"workfinished"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这个例子很简单，点击按钮，线程启动。结束之后发送一个信号出来。</p><p>官方已经不推荐这种写法，这种写法只有run()函数才会在新的线程中。自己线程发的信号槽如果不注意的话，线程的槽函数也不会响应的。</p><p>下面介绍新的写法，重写QObject，move到新的线程中。</p><p>样例代码 </p><p><a href="https://github.com/CryFeiFei/Qt_Teach/tree/master/Qt_Teach/Thread1" target="_blank" rel="noopener" title="https://github.com/CryFeiFei/Qt_Teach/tree/master/Qt_Teach/Thread1">https://github.com/CryFeiFei/Qt_Teach/tree/master/Qt_Teach/Thread1</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> Qt多线程 </tag>
            
            <tag> Qt基础教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qt基础教程</title>
      <link href="/2020/05/30/qt-ji-chu-jiao-cheng/"/>
      <url>/2020/05/30/qt-ji-chu-jiao-cheng/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>磕磕绊绊，自己也学Qt很久了。本意想弄个视频教程来教大家如何入门Qt，然后自己还是懒癌犯了，我还是喜欢讲解Qt的源码。</p><p>目前Qt的基础教程还是很多的，但是质量堪忧。刚入门时我看的时豆子君的学习之路，然后还是学到了不少的东西，也慢慢的对Qt有了自己的看法。回头看豆子君的教程还是有一些可以补充的。</p><p>这次搞Qt的基础教程，我准备把我认为该补充的文章结合豆子大佬的教程搞一份新的教程出来。给豆子君发邮件也已经得到了他的允许。<a href="https://www.cryfeifei.cn/532.html" target="_blank" rel="noopener" title="往来邮件">往来邮件</a></p><p>还有二三里的教程-Qt一二三，我看已经停更了，我也准备把他的停更的文章以及模块补充一些。（看来高级部分已经收费了</p><p>目前基本就是这样的想法。准备整理一份新的Qt基础教程。</p><p>我会一点点整理出来的。</p><h1 id="Qt-基本概念"><a href="#Qt-基本概念" class="headerlink" title="Qt 基本概念"></a>Qt 基本概念</h1><ul><li><a href="https://www.cryfeifei.cn/539.html" target="_blank" rel="noopener" title="Qt的基本概念-WIKI">Qt的基本概念-WIKI</a></li></ul><p>引读</p><blockquote><p><a href="https://www.cryfeifei.cn/541.html" target="_blank" rel="noopener" title="Qt简介">Qt简介</a><br><a href="https://www.cryfeifei.cn/545.html" target="_blank" rel="noopener" title="关于Qt">关于Qt</a><br><a href="https://www.cryfeifei.cn/542.html" target="_blank" rel="noopener" title="姚冬对Qt的看法">姚冬对Qt的看法</a></p></blockquote><h1 id="开发环境的搭建"><a href="#开发环境的搭建" class="headerlink" title="开发环境的搭建"></a>开发环境的搭建</h1><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><ul><li><a href="https://www.cryfeifei.cn/620.html" target="_blank" rel="noopener" title="Windows下VS2019编译Qt5.13.2源码">Windows下VS2019编译Qt5.13.2源码</a></li></ul><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><ul><li><a href="https://www.cryfeifei.cn/577.html" target="_blank" rel="noopener" title="Linux搭建Qt5.14开发环境">Linux搭建Qt5.14开发环境-傻瓜式</a>;</li><li><a href="https://www.cryfeifei.cn/611.html" target="_blank" rel="noopener" title="Linux搭建Qt5.14开发环境-源码编译">Linux搭建Qt5.14开发环境-源码编译</a></li></ul><h1 id="Qt-比较重要的概念"><a href="#Qt-比较重要的概念" class="headerlink" title="Qt 比较重要的概念"></a>Qt 比较重要的概念</h1><h1 id="Qt-容器类"><a href="#Qt-容器类" class="headerlink" title="Qt 容器类"></a>Qt 容器类</h1><h1 id="Qt-MVC"><a href="#Qt-MVC" class="headerlink" title="Qt MVC"></a>Qt MVC</h1><h1 id="Qt-Widget"><a href="#Qt-Widget" class="headerlink" title="Qt Widget"></a>Qt Widget</h1><h1 id="Qt-Core"><a href="#Qt-Core" class="headerlink" title="Qt Core"></a>Qt Core</h1><h1 id="Qt多线程"><a href="#Qt多线程" class="headerlink" title="Qt多线程"></a>Qt多线程</h1><h1 id="Qt网络"><a href="#Qt网络" class="headerlink" title="Qt网络"></a>Qt网络</h1><h1 id="Qt打印"><a href="#Qt打印" class="headerlink" title="Qt打印"></a>Qt打印</h1>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Qt主界面卡死的解决方案-一些具体实现方式</title>
      <link href="/2020/05/28/qt-zhu-jie-mian-qia-si-de-jie-jue-fang-an-yi-xie-ju-ti-shi-xian-fang-shi/"/>
      <url>/2020/05/28/qt-zhu-jie-mian-qia-si-de-jie-jue-fang-an-yi-xie-ju-ti-shi-xian-fang-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>我们在写UI文件的时候，有很多情况下，是需要界面来处理业务中某些耗时的操作，这时候如果不处理好界面相关的逻辑的话，主界面就会卡死，这时候就需要我们上多线程了</p><h2 id="逻辑1"><a href="#逻辑1" class="headerlink" title="逻辑1"></a>逻辑1</h2><p>首先上业务上一个很简单的栗子</p><p>比如我们的代码中有这么一个耗时的操作</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">// 第一种耗时的操作</span>    <span class="token keyword">auto</span> fWhile1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>把这个代码绑定到一个按钮事件上</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token operator">-</span><span class="token operator">></span>pushButton1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QPushButton<span class="token operator">::</span>clicked<span class="token punctuation">,</span> fWhile1<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后点击。发现界面卡死了，很正常，必须得等到这段代码耗时完成之后才能继续操作界面，这段代码是太不友好了，不清真，所以我们要改一下。</p><hr><h2 id="逻辑2"><a href="#逻辑2" class="headerlink" title="逻辑2"></a>逻辑2</h2><p>如何改动，可以看下这个函数</p><pre class=" language-cpp"><code class="language-cpp">QCoreApplication<span class="token operator">::</span>processEvents</code></pre><p>来一起看下官网介绍</p><blockquote><p>Processes all pending events for the calling thread according to the specified flags until there are no more events to process.<br>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).<br>In the event that you are running a local loop which calls this function continuously, without an event loop, the DeferredDelete events will not be processed. This can affect the behaviour of widgets, e.g. QToolTip, that rely on DeferredDelete events to function properly. An alternative would be to call sendPostedEvents() from within that local loop.<br>Calling this function processes events only for the calling thread.<br>Note: This function is thread-safe.</p></blockquote><ul><li>You can call this function occasionally when your program is busy performing a long operation (e.g. copying a file).</li><li>当程序忙于执行长时间操作（例如复制文件）时，您可以偶尔调用此功能。</li></ul><p>我们就暂时就这个（滑稽。<br>接下来可以把代码搞成这种了。</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token keyword">auto</span> fWhile2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>            QApplication<span class="token operator">::</span><span class="token function">processEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token operator">-</span><span class="token operator">></span>pushButton2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QPushButton<span class="token operator">::</span>clicked<span class="token punctuation">,</span> fWhile2<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这种代码在配置不好的机器上实际上还是有点小问题，比如我的小破本子。还是会有点卡的。我觉得用户一般是可以接受这种情况的。</p><hr><h2 id="逻辑3"><a href="#逻辑3" class="headerlink" title="逻辑3"></a>逻辑3</h2><p>实际上这个逻辑还有一个问题，就是如果我的业务代码不是循环该怎么办呢，这时候我们可以用新的类接口</p><pre class=" language-cpp"><code class="language-cpp">QtConcurrent<span class="token operator">::</span>run</code></pre><p>这个类。这个类是可以将一个函数放到新的线程里来执行。再加上</p><pre class=" language-cpp"><code class="language-cpp">QFuture<span class="token operator">&lt;</span>T<span class="token operator">></span></code></pre><p>这个类，可以控制这个新的线程函数开始，控制，结束。<br>具体可以查看官方文档，我这里就上个简单的栗子</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//耗时的操作</span><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">function_needmoretime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// three</span>    <span class="token keyword">auto</span> fWhile3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">void</span>    <span class="token punctuation">{</span>        QFuture<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> future <span class="token operator">=</span> QtConcurrent<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span>function_needmoretime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            QApplication<span class="token operator">::</span><span class="token function">processEvents</span><span class="token punctuation">(</span>QEventLoop<span class="token operator">::</span>AllEvents<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token operator">-</span><span class="token operator">></span>pushButton3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QPushButton<span class="token operator">::</span>clicked<span class="token punctuation">,</span> fWhile3<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>QFuture + QtConcurrent这个框架非常强大，可以将线程同步异步状态抽象出来，让程序员不用太关心这些。这只是一个最简单的栗子。我的小破本子来运行这个是一点都不卡的。界面依旧如丝滑般流畅。</p><hr><h2 id="逻辑4-线程"><a href="#逻辑4-线程" class="headerlink" title="逻辑4-线程"></a>逻辑4-线程</h2><p>线程基础那种废话我就不多说了。道理大家都懂，我直接上wiki。</p><blockquote><p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在Unix System V及SunOS中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。<br>线程是独立调度和分派的基本单位。线程可以为操作系统内核调度的内核线程，如Win32线程；由用户进程自行调度的用户线程，如Linux平台的POSIX Thread；或者由内核与用户进程，如Windows 7的线程，进行混合调度。<br>同一进程中的多条线程将共享该进程中的全部系统资源，如虚拟地址空间，文件描述符和信号处理等等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。<br>一个进程可以有很多线程，每条线程并行执行不同的任务。<br>在多核或多CPU，或支持Hyper-threading的CPU上使用多线程程序设计的好处是显而易见，即提高了程序的执行吞吐率。在单CPU单核的计算机上，使用多线程技术，也可以把进程中负责I/O处理、人机交互而常被阻塞的部分与密集计算的部分分开来执行，编写专门的workhorse线程执行密集计算，从而提高了程序的执行效率。 </p></blockquote><p>线程的创建有两种方式，第一种是继承QThread的方式，然后重写run，但是这种方式官方已经不推荐了。官方不推荐的我们就不要这样写了，我们这里讨论的是第二种方式。</p><p>继承QObject ，move到新的线程中。</p><h3 id="重写-QObject"><a href="#重写-QObject" class="headerlink" title="重写 QObject"></a>重写 QObject</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// 头文件</span><span class="token keyword">class</span> <span class="token class-name">workThread</span> <span class="token operator">:</span> <span class="token keyword">public</span> QObject<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">workThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">workThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> slots<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">start1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>signals<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">workStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//cpp</span>workThread<span class="token operator">::</span><span class="token function">workThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">QObject</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>workThread<span class="token operator">::</span><span class="token operator">~</span><span class="token function">workThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">void</span> workThread<span class="token operator">::</span><span class="token function">start1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    emit <span class="token function">workStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> workThread<span class="token operator">::</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    emit <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>使用方法</p><pre class=" language-cpp"><code class="language-cpp">    QThread<span class="token operator">*</span> m_workerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    workThread<span class="token operator">*</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">workThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    worker<span class="token operator">-</span><span class="token operator">></span><span class="token function">moveToThread</span><span class="token punctuation">(</span>m_workerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>m_workerThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>started<span class="token punctuation">,</span> worker<span class="token punctuation">,</span> <span class="token operator">&amp;</span>workThread<span class="token operator">::</span>start1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token operator">&amp;</span>workThread<span class="token operator">::</span>workFinished<span class="token punctuation">,</span> m_workerThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>quit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>m_workerThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>finished<span class="token punctuation">,</span> m_workerThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>deleteLater<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//也可以退出释放资源</span><span class="token comment" spellcheck="true">//    connect(qApp, &amp;QApplication::aboutToQuit, worker, &amp;QObject::deleteLater);</span><span class="token comment" spellcheck="true">//    connect(worker, &amp;QObject::destroyed, m_workerThread, &amp;QThread::quit);</span><span class="token comment" spellcheck="true">//    connect(m_workerThread, &amp;QThread::finished, m_workerThread, &amp;QThread::deleteLater);</span></code></pre><p>总结下这样的操作界面是一点都不卡的，因为延迟的操作我们放到新的线程中了。<br>如果需要传递数据的话，可以将数据通过信号槽的方式传递。</p><ul><li>之所以官方不推荐重写QThread也是因为无法使用信号槽</li><li>想继承QThread的话也可以，这个继承QThread的类也需要moveToThread，这种做法不清真，所以不希望大家用。</li></ul><hr><h2 id="逻辑5-线程-定时器"><a href="#逻辑5-线程-定时器" class="headerlink" title="逻辑5 线程 + 定时器"></a>逻辑5 线程 + 定时器</h2><p>实际上，就是逻辑4的进阶版本，再加个定时器，每隔两秒输出当前时间</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">TimerThread</span> <span class="token operator">:</span> <span class="token keyword">public</span> QObject<span class="token punctuation">{</span>    Q_OBJECT<span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">TimerThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">TimerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>signals<span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">workStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> timerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>TimerThread<span class="token operator">::</span><span class="token function">TimerThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">QObject</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>TimerThread<span class="token operator">::</span><span class="token operator">~</span><span class="token function">TimerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">void</span> TimerThread<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    emit <span class="token function">workStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    QTimer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTimer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QTimer<span class="token operator">::</span>timeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>TimerThread<span class="token operator">::</span>doWork<span class="token punctuation">)</span><span class="token punctuation">;</span>    timer<span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> TimerThread<span class="token operator">::</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    timerCount <span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timerCount <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>        emit <span class="token function">workFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>QTime<span class="token operator">::</span><span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>业务代码在这里</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token keyword">auto</span> fTimerThreadStart <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">void</span>    <span class="token punctuation">{</span>        fiveThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token operator">-</span><span class="token operator">></span>threadButton2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QPushButton<span class="token operator">::</span>clicked<span class="token punctuation">,</span> fTimerThreadStart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>fiveThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>started<span class="token punctuation">,</span> timerObject<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TimerThread<span class="token operator">::</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>timerObject<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TimerThread<span class="token operator">::</span>workFinished<span class="token punctuation">,</span> fiveThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>quit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">connect</span><span class="token punctuation">(</span>fiveThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>finished<span class="token punctuation">,</span> fiveThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QThread<span class="token operator">::</span>deleteLater<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>界面也是灰常丝滑般流畅的。具体的业务逻辑需求可以再想。</p>]]></content>
      
      
      <categories>
          
          <category> Qt </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Qt </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2020/05/28/hello-world/"/>
      <url>/2020/05/28/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class=" language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class=" language-bash"><code class="language-bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class=" language-bash"><code class="language-bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class=" language-bash"><code class="language-bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
